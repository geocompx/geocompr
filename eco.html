<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 15 Ecology | Geocomputation with R</title>
<meta name="author" content="Robin Lovelace, Jakub Nowosad, Jannes Muenchow">
<meta name="description" content="Prerequisites This chapter assumes you have a strong grasp of geographic data analysis and processing, covered in Chapters 2 to 5. The chapter makes use of bridges to GIS software, and spatial...">
<meta name="generator" content="bookdown 0.43 with bs4_book()">
<meta property="og:title" content="Chapter 15 Ecology | Geocomputation with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r.geocompx.org/eco.html">
<meta property="og:image" content="https://r.geocompx.org/images/cover2.png">
<meta property="og:description" content="Prerequisites This chapter assumes you have a strong grasp of geographic data analysis and processing, covered in Chapters 2 to 5. The chapter makes use of bridges to GIS software, and spatial...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 15 Ecology | Geocomputation with R">
<meta name="twitter:description" content="Prerequisites This chapter assumes you have a strong grasp of geographic data analysis and processing, covered in Chapters 2 to 5. The chapter makes use of bridges to GIS software, and spatial...">
<meta name="twitter:image" content="https://r.geocompx.org/images/cover2.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Lato-0.4.10/font.css" rel="stylesheet">
<link href="libs/Roboto_Mono-0.4.10/font.css" rel="stylesheet">
<link href="libs/Montserrat-0.4.10/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><meta name="citation_title" content="Chapter 15 Ecology | Geocomputation with R">
<meta name="citation_author" content="Robin Lovelace">
<meta name="citation_author" content="Jakub Nowosad">
<meta name="citation_author" content="Jannes Muenchow">
<meta name="citation_publication_date" content="2019">
<meta name="citation_isbn" content="9780203730058">
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-99618359-1', 'auto');
      ga('send', 'pageview');

    </script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-VDC2S0ZNH5"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-VDC2S0ZNH5');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h2>
        <a href="index.html" title="">Geocomputation with R</a>
      </h2>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword-1st-edition.html">Foreword (1st Edition)</a></li>
<li><a class="" href="foreword-2nd-edition.html">Foreword (2nd Edition)</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="spatial-class.html"><span class="header-section-number">2</span> Geographic data in R</a></li>
<li><a class="" href="attr.html"><span class="header-section-number">3</span> Attribute data operations</a></li>
<li><a class="" href="spatial-operations.html"><span class="header-section-number">4</span> Spatial data operations</a></li>
<li><a class="" href="geometry-operations.html"><span class="header-section-number">5</span> Geometry operations</a></li>
<li><a class="" href="raster-vector.html"><span class="header-section-number">6</span> Raster-vector interactions</a></li>
<li><a class="" href="reproj-geo-data.html"><span class="header-section-number">7</span> Reprojecting geographic data</a></li>
<li><a class="" href="read-write.html"><span class="header-section-number">8</span> Geographic data I/O</a></li>
<li class="book-part">Extensions</li>
<li><a class="" href="adv-map.html"><span class="header-section-number">9</span> Making maps with R</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">10</span> Bridges to GIS software</a></li>
<li><a class="" href="algorithms.html"><span class="header-section-number">11</span> Scripts, algorithms and functions</a></li>
<li><a class="" href="spatial-cv.html"><span class="header-section-number">12</span> Statistical learning</a></li>
<li class="book-part">Applications</li>
<li><a class="" href="transport.html"><span class="header-section-number">13</span> Transportation</a></li>
<li><a class="" href="location.html"><span class="header-section-number">14</span> Geomarketing</a></li>
<li><a class="active" href="eco.html"><span class="header-section-number">15</span> Ecology</a></li>
<li><a class="" href="conclusion.html"><span class="header-section-number">16</span> Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/geocompx/geocompr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="eco" class="section level1" number="15">
<h1>
<span class="header-section-number">15</span> Ecology<a class="anchor" aria-label="anchor" href="#eco"><i class="fas fa-link"></i></a>
</h1>
<div id="prerequisites-13" class="section level2 unnumbered">
<h2>Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-13"><i class="fas fa-link"></i></a>
</h2>
<p>This chapter assumes you have a strong grasp of geographic data analysis and processing, covered in Chapters <a href="spatial-class.html#spatial-class">2</a> to <a href="geometry-operations.html#geometry-operations">5</a>.
The chapter makes use of bridges to GIS software, and spatial cross-validation, covered in Chapters <a href="gis.html#gis">10</a> and <a href="spatial-cv.html#spatial-cv">12</a>, respectively.</p>
<p>The chapter uses the following packages:</p>
<div class="sourceCode" id="cb489"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>        <span class="co"># fast data frame manipulation (used by mlr3)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span>              <span class="co"># machine learning (see Chapter 12)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3spatiotempcv.mlr-org.com/">mlr3spatiotempcv</a></span><span class="op">)</span>  <span class="co"># spatiotemporal resampling </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a></span><span class="op">)</span>        <span class="co"># hyperparameter tuning package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span>      <span class="co"># interface to most important machine learning pkgs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paradox.mlr-org.com">paradox</a></span><span class="op">)</span>           <span class="co"># defining hyperparameter spaces</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://imbs-hl.github.io/ranger/">ranger</a></span><span class="op">)</span>            <span class="co"># random forest package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/qgisprocess/">qgisprocess</a></span><span class="op">)</span>       <span class="co"># bridge to QGIS (Chapter 10)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span>              <span class="co"># decision tree package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vegandevs.github.io/vegan/">vegan</a></span><span class="op">)</span>             <span class="co"># community ecology package</span></span></code></pre></div>
</div>
<div id="introduction-9" class="section level2" number="15.1">
<h2>
<span class="header-section-number">15.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-9"><i class="fas fa-link"></i></a>
</h2>
<p>This chapter models the floristic gradient of fog oases to reveal distinctive vegetation belts that are clearly controlled by water availability.
The case study provides an opportunity to bring together and extend concepts presented in previous chapters to further enhance your skills at using R for geocomputation.</p>
<p>Fog oases, locally called <em>lomas</em>, are vegetation formations found on mountains along the coastal deserts of Peru and Chile.
Similar ecosystems can be found elsewhere, including in the deserts of Namibia and along the coasts of Yemen and Oman <span class="citation">(<a href="references.html#ref-galletti_land_2016">Galletti, Turner, and Myint 2016</a>)</span>.
Despite the arid conditions and low levels of precipitation of around 30-50 mm per year on average, fog deposition increases the amount of water available to plants during austral winter, resulting in green southern-facing mountain slopes along the coastal strip of Peru.
The fog, which develops below the temperature inversion caused by the cold Humboldt current in austral winter, provides the name for this habitat.
Every few years, the El Niño phenomenon brings torrential rainfall to this sun-baked environment, providing tree seedlings a chance to develop roots long enough to survive the following arid conditions <span class="citation">(<a href="references.html#ref-dillon_lomas_2003">Dillon, Nakazawa, and Leiva 2003</a>)</span>.</p>
<p>Unfortunately, fog oases are heavily endangered, primarily due to agriculture and anthropogenic climate change.
Evidence on the composition and spatial distribution of the native flora can support efforts to protect remaining fragments of fog oases <span class="citation">(<a href="references.html#ref-muenchow_predictive_2013">Muenchow, Bräuning, et al. 2013</a>; <a href="references.html#ref-muenchow_soil_2013">Muenchow, Hauenstein, et al. 2013</a>)</span>.</p>
<p>In this chapter you will analyze the composition and the spatial distribution of vascular plants (here referring mostly to flowering plants) on the southern slope of Mt. Mongón, a <em>lomas</em> mountain near Casma on the central northern coast of Peru (Figure <a href="eco.html#fig:study-area-mongon">15.1</a>).
During a field study to Mt. Mongón, all vascular plants living in 100 randomly sampled 4 by 4 m<sup>2</sup> plots in the austral winter of 2011 were recorded <span class="citation">(<a href="references.html#ref-muenchow_predictive_2013">Muenchow, Bräuning, et al. 2013</a>)</span>.
The sampling coincided with a strong La Niña event that year, as shown in data published by the National Oceanic and Atmospheric Administration (<a href="https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php">NOAA</a>).
This led to even higher levels of aridity than usual in the coastal desert and increased fog activity on the southern slopes of Peruvian <em>lomas</em> mountains.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:study-area-mongon"></span>
<img src="images/15_study_area_mongon.png" alt="The Mt. Mongón study area. Figure taken from Muenchow, Schratz, and Brenning (2017)." width="60%"><p class="caption">
FIGURE 15.1: The Mt. Mongón study area. Figure taken from Muenchow, Schratz, and Brenning (2017).
</p>
</div>
<p>This chapter also demonstrates how to apply techniques covered in previous chapters to an important applied field: ecology.
Specifically, we will:</p>
<ul>
<li>Load in needed data and compute environmental predictors (Section <a href="eco.html#data-and-data-preparation">15.2</a>)</li>
<li>Extract the main floristic gradient from our species composition matrix with the help of a dimension-reducing technique (ordinations; Section <a href="eco.html#nmds">15.3</a>)</li>
<li>Model the first ordination axis, i.e., the floristic gradient, as a function of environmental predictors such as altitude, slope, catchment area and NDVI (Section <a href="eco.html#modeling-the-floristic-gradient">15.4</a>).
For this, we will make use of a random forest model — a very popular machine learning algorithm <span class="citation">(<a href="references.html#ref-breiman_random_2001">Breiman 2001</a>)</span>. To guarantee an optimal prediction, it is advisable to tune beforehand the hyperparameters with the help of spatial cross-validation (see Section <a href="spatial-cv.html#svm">12.5.2</a>)</li>
<li>Make a spatial distribution map of the floristic composition anywhere in the study area (Section <a href="eco.html#predictive-mapping">15.4.2</a>)</li>
</ul>
</div>
<div id="data-and-data-preparation" class="section level2" number="15.2">
<h2>
<span class="header-section-number">15.2</span> Data and data preparation<a class="anchor" aria-label="anchor" href="#data-and-data-preparation"><i class="fas fa-link"></i></a>
</h2>
<p>All the data needed for the subsequent analyses is available via the <strong>spDataLarge</strong> package.</p>
<div class="sourceCode" id="cb490"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"study_area"</span>, <span class="st">"random_points"</span>, <span class="st">"comm"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/dem.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ndvi</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/ndvi.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>study_area</code> is a polygon representing the outline of the study area, and <code>random_points</code> is an <code>sf</code> object containing the 100 randomly chosen sites.
<code>comm</code> is a community matrix of the wide data format <span class="citation">(<a href="references.html#ref-wickham_tidy_2014">Wickham 2014</a>)</span> where the rows represent the visited sites in the field and the columns the observed species.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;In statistics, this is also called a contingency table or cross-table.&lt;/p&gt;"><sup>101</sup></a></p>
<div class="sourceCode" id="cb491"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sites 35 to 40 and corresponding occurrences of the first five species in the</span></span>
<span><span class="co"># community matrix</span></span>
<span><span class="va">comm</span><span class="op">[</span><span class="fl">35</span><span class="op">:</span><span class="fl">40</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;    Alon_meri Alst_line Alte_hali Alte_porr Anth_eccr</span></span>
<span><span class="co">#&gt; 35         0         0         0       0.0     1.000</span></span>
<span><span class="co">#&gt; 36         0         0         1       0.0     0.500</span></span>
<span><span class="co">#&gt; 37         0         0         0       0.0     0.125</span></span>
<span><span class="co">#&gt; 38         0         0         0       0.0     3.000</span></span>
<span><span class="co">#&gt; 39         0         0         0       0.0     2.000</span></span>
<span><span class="co">#&gt; 40         0         0         0       0.2     0.125</span></span></code></pre></div>
<p>The values represent species cover per site, and were recorded as the area covered by a species in proportion to the site area (%; please note that one site can have &gt;100% due to overlapping cover between individual plants).
The rownames of <code>comm</code> correspond to the <code>id</code> column of <code>random_points</code>.
<code>dem</code> is the digital elevation model (DEM) for the study area, and <code>ndvi</code> is the Normalized Difference Vegetation Index (NDVI) computed from the red and near-infrared channels of a Landsat scene (see Section <a href="spatial-operations.html#local-operations">4.3.3</a> and <code><a href="https://rdrr.io/pkg/spDataLarge/man/ndvi.tif.html">?spDataLarge::ndvi.tif</a></code>).
Visualizing the data helps to get more familiar with it, as shown in Figure <a href="eco.html#fig:sa-mongon">15.2</a> where the <code>dem</code> is overplotted by the <code>random_points</code> and the <code>study_area</code>.</p>
<p></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:sa-mongon"></span>
<img src="images/15_sa_mongon_sampling.png" alt="Study mask (polygon), location of the sampling sites (black points) and DEM in the background." width="100%"><p class="caption">
FIGURE 15.2: Study mask (polygon), location of the sampling sites (black points) and DEM in the background.
</p>
</div>
<p>The next step is to compute variables which are not only needed for the modeling and predictive mapping (see Section <a href="eco.html#predictive-mapping">15.4.2</a>) but also for aligning the non-metric multidimensional scaling (NMDS) axes with the main gradient in the study area, altitude and humidity, respectively (see Section <a href="eco.html#nmds">15.3</a>).</p>
<p>Specifically, we compute catchment slope and catchment area from a digital elevation model using R-GIS bridges (see Chapter <a href="gis.html#gis">10</a>).
Curvatures might also represent valuable predictors, and in the Exercise section you can find out how they would impact the modeling result.</p>
<p>To compute catchment area and catchment slope, we can make use of the <code>sagang:sagawetnessindex</code> function.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Admittedly, it is a bit unsatisfying that the only way of knowing that &lt;code&gt;sagawetnessindex&lt;/code&gt; computes the desired terrain attributes is to be familiar with SAGA.&lt;/p&gt;"><sup>102</sup></a>
<code><a href="https://r-spatial.github.io/qgisprocess/reference/qgis_show_help.html">qgis_show_help()</a></code> returns all function parameters and default values of a specific geoalgorithm.
Here, we present only a selection of the complete output.</p>
<div class="sourceCode" id="cb492"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if not already done, enable the saga next generation plugin</span></span>
<span><span class="fu">qgisprocess</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/qgisprocess/reference/qgis_enable_plugins.html">qgis_enable_plugins</a></span><span class="op">(</span><span class="st">"processing_saga_nextgen"</span><span class="op">)</span></span>
<span><span class="co"># show help</span></span>
<span><span class="fu">qgisprocess</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/qgisprocess/reference/qgis_show_help.html">qgis_show_help</a></span><span class="op">(</span><span class="st">"sagang:sagawetnessindex"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Saga wetness index (sagang:sagawetnessindex)</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt; Arguments</span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; DEM: Elevation</span></span>
<span><span class="co">#&gt;  Argument type:  raster</span></span>
<span><span class="co">#&gt;  Acceptable values:</span></span>
<span><span class="co">#&gt;      - Path to a raster layer</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; SLOPE_TYPE: Type of Slope</span></span>
<span><span class="co">#&gt;  Argument type:  enum</span></span>
<span><span class="co">#&gt;  Available values:</span></span>
<span><span class="co">#&gt;      - 0: [0] local slope</span></span>
<span><span class="co">#&gt;      - 1: [1] catchment slope</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; AREA: Catchment area</span></span>
<span><span class="co">#&gt;  Argument type:  rasterDestination</span></span>
<span><span class="co">#&gt;  Acceptable values:</span></span>
<span><span class="co">#&gt;      - Path for new raster layer</span></span>
<span><span class="co">#&gt;... </span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt; Outputs</span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; AREA: &lt;outputRaster&gt;</span></span>
<span><span class="co">#&gt;  Catchment area</span></span>
<span><span class="co">#&gt; SLOPE: &lt;outputRaster&gt;</span></span>
<span><span class="co">#&gt;  Catchment slope</span></span>
<span><span class="co">#&gt; ...</span></span></code></pre></div>
<p>Subsequently, we can specify the needed parameters using R named arguments (see Section <a href="gis.html#rqgis">10.2</a>).
Remember that we can use a path to a file on disk or a <code>SpatRaster</code> living in R’s global environment to specify the input raster <code>DEM</code> (see Section <a href="gis.html#rqgis">10.2</a>).
Specifying 1 as the <code>SLOPE_TYPE</code> makes sure that the algorithm will return the catchment slope.
The resulting rasters are saved to temporary files with an <code>.sdat</code> extension which is the native SAGA raster format.</p>
<div class="sourceCode" id="cb493"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># environmental predictors: catchment slope and catchment area</span></span>
<span><span class="va">ep</span> <span class="op">=</span> <span class="fu">qgisprocess</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/qgisprocess/reference/qgis_run_algorithm.html">qgis_run_algorithm</a></span><span class="op">(</span></span>
<span>  alg <span class="op">=</span> <span class="st">"sagang:sagawetnessindex"</span>,</span>
<span>  DEM <span class="op">=</span> <span class="va">dem</span>,</span>
<span>  SLOPE_TYPE <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  SLOPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".sdat"</span><span class="op">)</span>,</span>
<span>  AREA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".sdat"</span><span class="op">)</span>,</span>
<span>  .quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This returns a list named <code>ep</code> containing the paths to the computed output rasters.
Let’s read-in catchment area as well as catchment slope into a multi-layer <code>SpatRaster</code> object (see Section <a href="spatial-class.html#raster-classes">2.3.4</a>).
Additionally, we will add two more raster objects to it, namely <code>dem</code> and <code>ndvi</code>.</p>
<div class="sourceCode" id="cb494"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read in catchment area and catchment slope</span></span>
<span><span class="va">ep</span> <span class="op">=</span> <span class="va">ep</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"SLOPE"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">ep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"carea"</span>, <span class="st">"cslope"</span><span class="op">)</span> <span class="co"># assign better names </span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/origin.html">origin</a></span><span class="op">(</span><span class="va">ep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/origin.html">origin</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="co"># make sure rasters have the same origin</span></span>
<span><span class="va">ep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">ndvi</span>, <span class="va">ep</span><span class="op">)</span> <span class="co"># add dem and ndvi to the multi-layer SpatRaster object</span></span></code></pre></div>
<p>Additionally, the catchment area values are highly skewed to the right (<code>hist(ep$carea)</code>).
A log10-transformation makes the distribution more normal.</p>
<div class="sourceCode" id="cb495"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ep</span><span class="op">$</span><span class="va">carea</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">ep</span><span class="op">$</span><span class="va">carea</span><span class="op">)</span></span></code></pre></div>
<p>As a convenience to the reader, we have added <code>ep</code> to <strong>spDataLarge</strong>:</p>
<div class="sourceCode" id="cb496"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ep</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/ep.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can extract the terrain attributes to our field observations (see also Section <a href="raster-vector.html#raster-extraction">6.3</a>).</p>
<div class="sourceCode" id="cb497"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ep_rp</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">ep</span>, <span class="va">random_points</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">random_points</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">random_points</span>, <span class="va">ep_rp</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="nmds" class="section level2" number="15.3">
<h2>
<span class="header-section-number">15.3</span> Reducing dimensionality<a class="anchor" aria-label="anchor" href="#nmds"><i class="fas fa-link"></i></a>
</h2>
<p>Ordinations are a popular tool in vegetation science to extract the main information, frequently corresponding to ecological gradients, from large species-plot matrices mostly filled with 0s.
However, they are also used in remote sensing, the soil sciences, geomarketing and many other fields.
If you are unfamiliar with ordination techniques or in need of a refresher, have a look at <a href="https://ordination.okstate.edu/overview.htm">Michael W. Palmer’s webpage</a> for a short introduction to popular ordination techniques in ecology and at <span class="citation">Borcard, Gillet, and Legendre (<a href="references.html#ref-borcard_numerical_2011">2011</a>)</span> for a deeper look on how to apply these techniques in R.
<strong>vegan</strong>’s package documentation is also a very helpful resource (<code>vignette(package = "vegan")</code>).</p>
<p>Principal component analysis (PCA) is probably the most famous ordination technique.
It is a great tool to reduce dimensionality if one can expect linear relationships between variables, and if the joint absence of a variable in two plots (observations) can be considered a similarity.
This is barely the case with vegetation data.</p>
<p>For one, the presence of a plant often follows a unimodal, i.e., a non-linear, relationship along a gradient (e.g., humidity, temperature or salinity) with a peak at the most favorable conditions and declining ends towards the unfavorable conditions.</p>
<p>Secondly, the joint absence of a species in two plots is hardly an indication for similarity.
Suppose a plant species is absent from the driest (e.g., an extreme desert) and the moistest locations (e.g., a tree savanna) of our sampling.
Then we really should refrain from counting this as a similarity because it is very likely that the only thing these two completely different environmental settings have in common in terms of floristic composition is the shared absence of species (except for rare ubiquitous species).</p>
<p>NMDS is one popular dimension-reducing technique used in ecology <span class="citation">(<a href="references.html#ref-vonwehrden_pluralism_2009">von Wehrden et al. 2009</a>)</span>.
NMDS reduces the rank-based differences between distances between objects in the original matrix and distances between the ordinated objects.
The difference is expressed as stress.
The lower the stress value, the better the ordination, i.e., the low-dimensional representation of the original matrix.
Stress values lower than 10 represent an excellent fit, stress values of around 15 are still good, and values greater than 20 represent a poor fit <span class="citation">(<a href="references.html#ref-mccune_analysis_2002">McCune, Grace, and Urban 2002</a>)</span>.
In R, <code><a href="https://vegandevs.github.io/vegan/reference/metaMDS.html">metaMDS()</a></code> of the <strong>vegan</strong> package can execute a NMDS.
As input, it expects a community matrix with the sites as rows and the species as columns.
Often ordinations using presence-absence data yield better results (in terms of explained variance) though the prize is, of course, a less informative input matrix (see also Exercises).
<code><a href="https://vegandevs.github.io/vegan/reference/decostand.html">decostand()</a></code> converts numerical observations into presences and absences with 1 indicating the occurrence of a species and 0 the absence of a species.
Ordination techniques such as NMDS require at least one observation per site.
Hence, we need to dismiss all sites in which no species were found.</p>
<div class="sourceCode" id="cb498"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># presence-absence matrix</span></span>
<span><span class="va">pa</span> <span class="op">=</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://vegandevs.github.io/vegan/reference/decostand.html">decostand</a></span><span class="op">(</span><span class="va">comm</span>, <span class="st">"pa"</span><span class="op">)</span>  <span class="co"># 100 rows (sites), 69 columns (species)</span></span>
<span><span class="co"># keep only sites in which at least one species was found</span></span>
<span><span class="va">pa</span> <span class="op">=</span> <span class="va">pa</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html">rowSums</a></span><span class="op">(</span><span class="va">pa</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="op">]</span>  <span class="co"># 84 rows, 69 columns</span></span></code></pre></div>
<p>The resulting matrix serves as input for the NMDS.
<code>k</code> specifies the number of output axes, here, set to 4.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;
One way of choosing &lt;code&gt;k&lt;/code&gt; is to try &lt;code&gt;k&lt;/code&gt; values between 1 and 6 and then using the result which yields the best stress value &lt;span class="citation"&gt;(&lt;a href="references.html#ref-mccune_analysis_2002"&gt;McCune, Grace, and Urban 2002&lt;/a&gt;)&lt;/span&gt;.&lt;/p&gt;'><sup>103</sup></a>
NMDS is an iterative procedure trying to make the ordinated space more similar to the input matrix in each step.
To make sure that the algorithm converges, we set the number of steps to 500 using the <code>try</code> parameter.</p>
<div class="sourceCode" id="cb499"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">25072018</span><span class="op">)</span></span>
<span><span class="va">nmds</span> <span class="op">=</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://vegandevs.github.io/vegan/reference/metaMDS.html">metaMDS</a></span><span class="op">(</span>comm <span class="op">=</span> <span class="va">pa</span>, k <span class="op">=</span> <span class="fl">4</span>, try <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">nmds</span><span class="op">$</span><span class="va">stress</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; Run 498 stress 0.08834745 </span></span>
<span><span class="co">#&gt; ... Procrustes: rmse 0.004100446  max resid 0.03041186 </span></span>
<span><span class="co">#&gt; Run 499 stress 0.08874805 </span></span>
<span><span class="co">#&gt; ... Procrustes: rmse 0.01822361  max resid 0.08054538 </span></span>
<span><span class="co">#&gt; Run 500 stress 0.08863627 </span></span>
<span><span class="co">#&gt; ... Procrustes: rmse 0.01421176  max resid 0.04985418 </span></span>
<span><span class="co">#&gt; *** Solution reached</span></span>
<span><span class="co">#&gt; 0.08831395</span></span></code></pre></div>
<p>A stress value of 9 represents a very good result, which means that the reduced ordination space represents the large majority of the variance of the input matrix.
Overall, NMDS puts objects that are more similar (in terms of species composition) closer together in ordination space.
However, as opposed to most other ordination techniques, the axes are arbitrary and not necessarily ordered by importance <span class="citation">(<a href="references.html#ref-borcard_numerical_2011">Borcard, Gillet, and Legendre 2011</a>)</span>.
However, we already know that humidity represents the main gradient in the study area <span class="citation">(<a href="references.html#ref-muenchow_predictive_2013">Muenchow, Bräuning, et al. 2013</a>; <a href="references.html#ref-muenchow_rqgis:_2017">Muenchow, Schratz, and Brenning 2017</a>)</span>.
Since humidity is highly correlated with elevation, we rotate the NMDS axes in accordance with elevation (see also <code><a href="https://vegandevs.github.io/vegan/reference/MDSrotate.html">?MDSrotate</a></code> for more details on rotating NMDS axes).
Plotting the result reveals that the first axis is, as intended, clearly associated with altitude (Figure <a href="eco.html#fig:xy-nmds">15.3</a>).</p>
<div class="sourceCode" id="cb500"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">random_points</span>, <span class="va">id</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">pa</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span>
<span><span class="co"># rotating NMDS in accordance with altitude (proxy for humidity)</span></span>
<span><span class="va">rotnmds</span> <span class="op">=</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://vegandevs.github.io/vegan/reference/MDSrotate.html">MDSrotate</a></span><span class="op">(</span><span class="va">nmds</span>, <span class="va">elev</span><span class="op">)</span></span>
<span><span class="co"># extracting the first two axes</span></span>
<span><span class="va">sc</span> <span class="op">=</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://vegandevs.github.io/vegan/reference/scores.html">scores</a></span><span class="op">(</span><span class="va">rotnmds</span>, choices <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, display <span class="op">=</span> <span class="st">"sites"</span><span class="op">)</span></span>
<span><span class="co"># plotting the first axis against altitude</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">sc</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">elev</span>, xlab <span class="op">=</span> <span class="st">"elevation in m"</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"First NMDS axis"</span>, cex.lab <span class="op">=</span> <span class="fl">0.8</span>, cex.axis <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:xy-nmds"></span>
<img src="images/15_xy_nmds.png" alt="Plotting the first NMDS axis against altitude." width="60%"><p class="caption">
FIGURE 15.3: Plotting the first NMDS axis against altitude.
</p>
</div>
<p>The scores of the first NMDS axis represent the different vegetation formations, i.e., the floristic gradient, appearing along the slope of Mt. Mongón.
To spatially visualize them, we can model the NMDS scores with the previously created predictors (Section <a href="eco.html#data-and-data-preparation">15.2</a>), and use the resulting model for predictive mapping (see Section <a href="eco.html#modeling-the-floristic-gradient">15.4</a>).</p>
</div>
<div id="modeling-the-floristic-gradient" class="section level2" number="15.4">
<h2>
<span class="header-section-number">15.4</span> Modeling the floristic gradient<a class="anchor" aria-label="anchor" href="#modeling-the-floristic-gradient"><i class="fas fa-link"></i></a>
</h2>
<p>To predict the floristic gradient spatially, we use a random forest model.
Random forest models are frequently applied in environmental and ecological modeling, and often provide the best results in terms of predictive performance <span class="citation">(<a href="references.html#ref-hengl_random_2018">Hengl et al. 2018</a>; <a href="references.html#ref-schratz_hyperparameter_2019">Schratz et al. 2019</a>)</span>.
Here, we shortly introduce decision trees and bagging, since they form the basis of random forests.
We refer the reader to <span class="citation">James et al. (<a href="references.html#ref-james_introduction_2013">2013</a>)</span> for a more detailed description of random forests and related techniques.</p>
<p>To introduce decision trees by example, we first construct a response-predictor matrix by joining the rotated NMDS scores to the field observations (<code>random_points</code>).
We will also use the resulting data frame for the <strong>mlr3</strong> modeling later on.</p>
<div class="sourceCode" id="cb501"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># construct response-predictor matrix</span></span>
<span><span class="co"># id- and response variable</span></span>
<span><span class="va">rp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span><span class="op">)</span>, sc <span class="op">=</span> <span class="va">sc</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># join the predictors (dem, ndvi and terrain attributes)</span></span>
<span><span class="va">rp</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">random_points</span>, <span class="va">rp</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<p>Decision trees split the predictor space into a number of regions.
To illustrate this, we apply a decision tree to our data using the scores of the first NMDS axis as the response (<code>sc</code>) and altitude (<code>dem</code>) as the only predictor.</p>
<div class="sourceCode" id="cb502"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_mo</span> <span class="op">=</span> <span class="fu">tree</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.html">tree</a></span><span class="op">(</span><span class="va">sc</span> <span class="op">~</span> <span class="va">dem</span>, data <span class="op">=</span> <span class="va">rp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">tree_mo</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/text.html">text</a></span><span class="op">(</span><span class="va">tree_mo</span>, pretty <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:tree"></span>
<img src="images/15_tree.png" alt="Simple example of a decision tree with three internal nodes and four terminal nodes." width="60%"><p class="caption">
FIGURE 15.4: Simple example of a decision tree with three internal nodes and four terminal nodes.
</p>
</div>
<p>The resulting tree consists of three internal nodes and four terminal nodes (Figure <a href="eco.html#fig:tree">15.4</a>).
The first internal node at the top of the tree assigns all observations which are below 328.5 m to the left and all other observations to the right branch.
The observations falling into the left branch have a mean NMDS score of -1.198.
Overall, we can interpret the tree as follows: the higher the elevation, the higher the NMDS score becomes.
This means that the simple decision tree has already revealed four distinct floristic assemblages.
For a more in-depth interpretation, please refer to Section <a href="eco.html#predictive-mapping">15.4.2</a>.
Decision trees have a tendency to overfit, that is, they mirror too closely the input data including its noise which in turn leads to bad predictive performances <span class="citation">(Section <a href="spatial-cv.html#intro-cv">12.4</a>, <a href="references.html#ref-james_introduction_2013">James et al. 2013</a>)</span>.
Bootstrap aggregation (bagging) is an ensemble technique that can help to overcome this problem.
Ensemble techniques simply combine the predictions of multiple models.
Thus, bagging takes repeated samples from the same input data and averages the predictions.
This reduces the variance and overfitting with the result of a much better predictive accuracy compared to decision trees.
Finally, random forests extend and improve bagging by decorrelating trees which is desirable since averaging the predictions of highly correlated trees shows a higher variance and thus lower reliability than averaging predictions of decorrelated trees <span class="citation">(<a href="references.html#ref-james_introduction_2013">James et al. 2013</a>)</span>.
To achieve this, random forests use bagging, but in contrast to the traditional bagging where each tree is allowed to use all available predictors, random forests only use a random sample of all available predictors.</p>
<!--
Recall that bagging is simply a special case of a random forest with m = p. Therefore, the randomForest() function can be used to perform both random forests and bagging. 
The argument mtry=13 indicates that all 13 predictors should be considered
for each split of the tree—in other words, that bagging should be done.
@james_introduction_2013
-->
<div id="mlr3-building-blocks" class="section level3" number="15.4.1">
<h3>
<span class="header-section-number">15.4.1</span> <strong>mlr3</strong> building blocks<a class="anchor" aria-label="anchor" href="#mlr3-building-blocks"><i class="fas fa-link"></i></a>
</h3>
<p>The code in this section largely follows the steps we have introduced in Section <a href="spatial-cv.html#svm">12.5.2</a>.
The only differences are the following:</p>
<ol style="list-style-type: decimal">
<li>The response variable is numeric, hence a regression task will replace the classification task of Section <a href="spatial-cv.html#svm">12.5.2</a>
</li>
<li>Instead of the AUROC which can only be used for categorical response variables, we will use the root mean squared error (RMSE) as the performance measure</li>
<li>We use a Random Forest model instead of a Support Vector Machine which naturally goes along with different hyperparameters</li>
<li>We are leaving the assessment of a bias-reduced performance measure as an exercise to the reader (see Exercises).
Instead, we show how to tune hyperparameters for (spatial) predictions</li>
</ol>
<p>Remember that 125,500 models were necessary to retrieve bias-reduced performance estimates when using 100-repeated 5-fold spatial cross-validation and a random search of 50 iterations in Section <a href="spatial-cv.html#svm">12.5.2</a>.
In the hyperparameter tuning level, we found the best hyperparameter combination which in turn was used in the outer performance level for predicting the test data of a specific spatial partition (see also Figure <a href="spatial-cv.html#fig:inner-outer">12.6</a>).
This was done for five spatial partitions, and repeated a 100 times yielding in total 500 optimal hyperparameter combinations.
Which one should we use for making spatial distribution maps?
The answer is simple: none at all.
Remember, the tuning was done to retrieve a bias-reduced performance estimate, not to do the best possible spatial prediction.
For the latter, one estimates the best hyperparameter combination from the complete dataset.
This means, the inner hyperparameter tuning level is no longer needed, which makes perfect sense since we are applying our model to new data (unvisited field observations) for which the true outcomes are unavailable, hence testing is impossible in any case.
Therefore, we tune the hyperparameters for a good spatial prediction on the complete dataset via a 5-fold spatial CV with one repetition.
<!-- If we used more than one repetition (say 2) we would retrieve multiple optimal tuned hyperparameter combinations (say 2) --></p>
<p>Having already constructed the input variables (<code>rp</code>), we are all set for specifying the <strong>mlr3</strong> building blocks (task, learner, and resampling).
For specifying a spatial task, we use again the <strong>mlr3spatiotempcv</strong> package <span class="citation">(<a href="references.html#ref-schratz_mlr3spatiotempcv_2021">Schratz et al. 2021</a> Section <a href="spatial-cv.html#spatial-cv-with-mlr3">12.5</a>)</span>, and since our response (<code>sc</code>) is numeric, we use a regression task.</p>
<div class="sourceCode" id="cb503"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create task</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">mlr3spatiotempcv</span><span class="fu">::</span><span class="fu"><a href="https://mlr3spatiotempcv.mlr-org.com/reference/as_task_regr_st.html">as_task_regr_st</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">rp</span>, <span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">spri</span><span class="op">)</span>,</span>
<span>  target <span class="op">=</span> <span class="st">"sc"</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"mongon"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Using an <code>sf</code> object as the backend automatically provides the geometry information needed for the spatial partitioning later on.
Additionally, we got rid of the columns <code>id</code> and <code>spri</code>, since these variables should not be used as predictors in the modeling.
Next, we go on to construct a random forest learner from the <strong>ranger</strong> package <span class="citation">(<a href="references.html#ref-wright_ranger_2017">Wright and Ziegler 2017</a>)</span>.</p>
<div class="sourceCode" id="cb504"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrn_rf</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, predict_type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p>As opposed to, for example, Support Vector Machines (see Section <a href="spatial-cv.html#svm">12.5.2</a>), random forests often already show good performances when used with the default values of their hyperparameters (which may be one reason for their popularity).
Still, tuning often moderately improves model results, and thus is worth the effort <span class="citation">(<a href="references.html#ref-probst_hyperparameters_2018">Probst, Wright, and Boulesteix 2018</a>)</span>.
In random forests, the hyperparameters <code>mtry</code>, <code>min.node.size</code> and <code>sample.fraction</code> determine the degree of randomness, and should be tuned <span class="citation">(<a href="references.html#ref-probst_hyperparameters_2018">Probst, Wright, and Boulesteix 2018</a>)</span>.
<code>mtry</code> indicates how many predictor variables should be used in each tree.
If all predictors are used, then this corresponds in fact to bagging (see beginning of Section <a href="eco.html#modeling-the-floristic-gradient">15.4</a>).
The <code>sample.fraction</code> parameter specifies the fraction of observations to be used in each tree.
Smaller fractions lead to greater diversity, and thus less correlated trees which often is desirable (see above).
The <code>min.node.size</code> parameter indicates the number of observations a terminal node should at least have (see also Figure <a href="eco.html#fig:tree">15.4</a>).
Naturally, as trees and computing time become larger, the lower the <code>min.node.size</code>.</p>
<p>Hyperparameter combinations will be selected randomly but should fall inside specific tuning limits (created with <code><a href="https://paradox.mlr-org.com/reference/ps.html">paradox::ps()</a></code>).
<code>mtry</code> should range between 1 and the number of predictors (4) <!-- (4)-->, <code>sample.fraction</code> should range between 0.2 and 0.9 and <code>min.node.size</code> should range between 1 and 10 <span class="citation">(<a href="references.html#ref-probst_hyperparameters_2018">Probst, Wright, and Boulesteix 2018</a>)</span>.</p>
<div class="sourceCode" id="cb505"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># specifying the search space</span></span>
<span><span class="va">search_space</span> <span class="op">=</span> <span class="fu">paradox</span><span class="fu">::</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span></span>
<span>  mtry <span class="op">=</span> <span class="fu">paradox</span><span class="fu">::</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">ncol</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu">paradox</span><span class="fu">::</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.2</span>, upper <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>  min.node.size <span class="op">=</span> <span class="fu">paradox</span><span class="fu">::</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Having defined the search space, we are all set for specifying our tuning via the <code><a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html">AutoTuner()</a></code> function.
Since we deal with geographic data, we will again make use of spatial cross-validation to tune the hyperparameters (see Sections <a href="spatial-cv.html#intro-cv">12.4</a> and <a href="spatial-cv.html#spatial-cv-with-mlr3">12.5</a>).
Specifically, we will use a 5-fold spatial partitioning with only one repetition (<code><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp()</a></code>).
In each of these spatial partitions, we run 50 models (<code><a href="https://bbotk.mlr-org.com/reference/trm.html">trm()</a></code>) while using randomly selected hyperparameter configurations (<code><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr()</a></code>) within predefined limits (<code>seach_space</code>) to find the optimal hyperparameter combination <span class="citation">(see also Section <a href="spatial-cv.html#svm">12.5.2</a> and <a href="https://mlr3book.mlr-org.com/chapters/chapter4/hyperparameter_optimization.html#sec-autotuner" class="uri">https://mlr3book.mlr-org.com/chapters/chapter4/hyperparameter_optimization.html#sec-autotuner</a>, <a href="references.html#ref-bischl_applied_2024">Bischl et al. 2024</a>)</span>.
The performance measure is the root mean squared error (RMSE).</p>
<div class="sourceCode" id="cb506"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autotuner_rf</span> <span class="op">=</span> <span class="fu">mlr3tuning</span><span class="fu">::</span><span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">lrn_rf</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"spcv_coords"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, <span class="co"># spatial partitioning</span></span>
<span>  measure <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>, <span class="co"># performance measure</span></span>
<span>  terminator <span class="op">=</span> <span class="fu">mlr3tuning</span><span class="fu">::</span><span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, <span class="co"># specify 50 iterations</span></span>
<span>  search_space <span class="op">=</span> <span class="va">search_space</span>, <span class="co"># predefined hyperparameter search space</span></span>
<span>  tuner <span class="op">=</span> <span class="fu">mlr3tuning</span><span class="fu">::</span><span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span> <span class="co"># specify random search</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Calling the <code>train()</code>-method of the <code>AutoTuner</code>-object finally runs the hyperparameter tuning, and will find the optimal hyperparameter combination for the specified parameters.</p>
<div class="sourceCode" id="cb507"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># hyperparameter tuning</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">24092024</span><span class="op">)</span></span>
<span><span class="va">autotuner_rf</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb508"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autotuner_rf</span><span class="op">$</span><span class="va">tuning_result</span></span>
<span><span class="co">#&gt;     mtry sample.fraction min.node.size learner_param_vals  x_domain regr.rmse</span></span>
<span><span class="co">#&gt;    &lt;int&gt;           &lt;num&gt;         &lt;int&gt;             &lt;list&gt;    &lt;list&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     4           0.784            10          &lt;list[4]&gt; &lt;list[3]&gt;     0.382</span></span></code></pre></div>
</div>
<div id="predictive-mapping" class="section level3" number="15.4.2">
<h3>
<span class="header-section-number">15.4.2</span> Predictive mapping<a class="anchor" aria-label="anchor" href="#predictive-mapping"><i class="fas fa-link"></i></a>
</h3>
<p>The tuned hyperparameters can now be used for the prediction.
To do so, we only need to run the <code>predict</code> method of our fitted <code>AutoTuner</code> object.</p>
<div class="sourceCode" id="cb509"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># predicting using the best hyperparameter combination</span></span>
<span><span class="va">autotuner_rf</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── &lt;PredictionRegr&gt; for 84 observations: ───────────────────────────────────────</span></span>
<span><span class="co">#&gt;  row_ids  truth response</span></span>
<span><span class="co">#&gt;        1 -1.084   -1.176</span></span>
<span><span class="co">#&gt;        2 -0.975   -1.176</span></span>
<span><span class="co">#&gt;        3 -0.912   -1.168</span></span>
<span><span class="co">#&gt;      ---    ---      ---</span></span>
<span><span class="co">#&gt;       82  0.814    0.594</span></span>
<span><span class="co">#&gt;       83  0.814    0.746</span></span>
<span><span class="co">#&gt;       84  0.808    0.807</span></span></code></pre></div>
<p>The <code>predict</code> method will apply the model to all observations used in the modeling.
Given a multi-layer <code>SpatRaster</code> containing rasters named as the predictors used in the modeling, <code><a href="https://rspatial.github.io/terra/reference/predict.html">terra::predict()</a></code> will also make spatial distribution maps, i.e., predict to new data.</p>
<div class="sourceCode" id="cb510"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html">predict</a></span><span class="op">(</span><span class="va">ep</span>, model <span class="op">=</span> <span class="va">autotuner_rf</span>, fun <span class="op">=</span> <span class="va">predict</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:rf-pred"></span>
<img src="images/15_rf_pred.png" alt="Predictive mapping of the floristic gradient clearly revealing distinct vegetation belts." width="100%"><p class="caption">
FIGURE 15.5: Predictive mapping of the floristic gradient clearly revealing distinct vegetation belts.
</p>
</div>
<p>In case, <code><a href="https://rspatial.github.io/terra/reference/predict.html">terra::predict()</a></code> does not support a model algorithm, you can still make the predictions manually.</p>
<div class="sourceCode" id="cb511"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html">as.matrix</a></span><span class="op">(</span><span class="va">ep</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html">colSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 0 NAs</span></span>
<span><span class="co"># but assuming there were 0s results in a more generic approach</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="va">autotuner_rf</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span>, task <span class="op">=</span> <span class="va">task</span><span class="op">)</span></span>
<span><span class="va">newdata</span><span class="op">[</span><span class="va">ind</span>, <span class="st">"pred"</span><span class="op">]</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">[[</span><span class="st">"response"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pred_2</span> <span class="op">=</span> <span class="va">ep</span><span class="op">$</span><span class="va">dem</span></span>
<span><span class="co"># now fill the raster with the predicted values</span></span>
<span><span class="va">pred_2</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="va">newdata</span><span class="op">$</span><span class="va">pred</span></span>
<span><span class="co"># check if terra and our manual prediction is the same</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html">values</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">-</span> <span class="va">pred_2</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>The predictive mapping clearly reveals distinct vegetation belts (Figure <a href="eco.html#fig:rf-pred">15.5</a>).
Please refer to <span class="citation">Muenchow, Hauenstein, et al. (<a href="references.html#ref-muenchow_soil_2013">2013</a>)</span> for a detailed description of vegetation belts on <em>lomas</em> mountains.
The blue color tones represent the so-called <em>Tillandsia</em> belt.
<em>Tillandsia</em> is a highly adapted genus especially found in high quantities at the sandy and quite desertic foot of <em>lomas</em> mountains.
The yellow color tones refer to a herbaceous vegetation belt with a much higher plant cover compared to the <em>Tillandsia</em> belt.
The orange colors represent the bromeliad belt, which features the highest species richness and plant cover.
It can be found directly beneath the temperature inversion (ca. 750-850 m asl) where humidity due to fog is highest.
Water availability naturally decreases above the temperature inversion, and the landscape becomes desertic again with only a few succulent species (succulent belt; red colors).
Interestingly, the spatial prediction clearly reveals that the bromeliad belt is interrupted, which is a very interesting finding we would have not detected without the predictive mapping.</p>
</div>
</div>
<div id="conclusions-1" class="section level2" number="15.5">
<h2>
<span class="header-section-number">15.5</span> Conclusions<a class="anchor" aria-label="anchor" href="#conclusions-1"><i class="fas fa-link"></i></a>
</h2>
<p>In this chapter we have ordinated the community matrix of the <em>lomas</em> Mt. Mongón with the help of a NMDS (Section <a href="eco.html#nmds">15.3</a>).
The first axis, representing the main floristic gradient in the study area, was modeled as a function of environmental predictors which partly were derived through R-GIS bridges (Section <a href="eco.html#data-and-data-preparation">15.2</a>).
The <strong>mlr3</strong> package provided the building blocks to spatially tune the hyperparameters <code>mtry</code>, <code>sample.fraction</code> and <code>min.node.size</code> (Section <a href="eco.html#mlr3-building-blocks">15.4.1</a>).
The tuned hyperparameters served as input for the final model which in turn was applied to the environmental predictors for a spatial representation of the floristic gradient (Section <a href="eco.html#predictive-mapping">15.4.2</a>).
The result demonstrates spatially the astounding biodiversity in the middle of the desert.
Since <em>lomas</em> mountains are heavily endangered, the prediction map can serve as basis for informed decision-making on delineating protection zones, and making the local population aware of the uniqueness found in their immediate neighborhood.</p>
<p>In terms of methodology, a few additional points could be addressed:</p>
<ul>
<li>It would be interesting to also model the second ordination axis, and to subsequently find an innovative way of visualizing jointly the modeled scores of the two axes in one prediction map</li>
<li>If we were interested in interpreting the model in an ecologically meaningful way, we should probably use (semi-)parametric models <span class="citation">(<a href="references.html#ref-muenchow_predictive_2013">Muenchow, Bräuning, et al. 2013</a>; <a href="references.html#ref-zuur_mixed_2009">A. Zuur et al. 2009</a>; <a href="references.html#ref-zuur_beginners_2017">A. F. Zuur et al. 2017</a>)</span>.
However, there are at least approaches that help to interpret machine learning models such as random forests (see, e.g., <a href="https://mlr-org.com/posts/2018-04-30-interpretable-machine-learning-iml-and-mlr/">https://mlr-org.com/posts/2018-04-30-interpretable-machine-learning-iml-and-mlr/</a>)</li>
<li>A sequential model-based optimization (SMBO) might be preferable to the random search for hyperparameter optimization used in this chapter <span class="citation">(<a href="references.html#ref-probst_hyperparameters_2018">Probst, Wright, and Boulesteix 2018</a>)</span>
</li>
</ul>
<p>Finally, please note that random forest and other machine learning models are frequently used in a setting with much more observations and predictors than used in this Chapter, and where it is unclear which variables and variable interactions contribute to explaining the response.
Additionally, the relationships might be highly non-linear.
In our use case, the relationship between response and predictors is pretty clear, there is only a slight amount of non-linearity and the number of observations and predictors is low.
Hence, it might be worth trying a linear model.
A linear model is much easier to explain and understand than a random forest model, and therefore preferred (law of parsimony).
Additionally it is computationally less demanding (see Exercises).
If the linear model cannot cope with the degree of non-linearity present in the data, one could also try a generalized additive model (GAM).
The point here is that the toolbox of a data scientist consists of more than one tool, and it is your responsibility to select the tool best suited for the task or purpose at hand.
Here, we wanted to introduce the reader to random forest modeling and how to use the corresponding results for predictive mapping purposes.
For this purpose, a well-studied dataset with known relationships between response and predictors, is appropriate.
However, this does not imply that the random forest model has returned the best result in terms of predictive performance.</p>
</div>
<div id="exercises-11" class="section level2" number="15.6">
<h2>
<span class="header-section-number">15.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-11"><i class="fas fa-link"></i></a>
</h2>
<p>The solutions assume the following packages are attached (other packages will be attached when needed):</p>
<p>E1. Run a NMDS using the percentage data of the community matrix.
Report the stress value and compare it to the stress value as retrieved from the NMDS using presence-absence data.
What might explain the observed difference?</p>
<p>E2. Compute all the predictor rasters we have used in the chapter (catchment slope, catchment area), and put them into a <code>SpatRaster</code>-object.
Add <code>dem</code> and <code>ndvi</code> to it.
Next, compute profile and tangential curvature and add them as additional predictor rasters (hint: <code>grass7:r.slope.aspect</code>).
Finally, construct a response-predictor matrix.
The scores of the first NMDS axis (which were the result when using the presence-absence community matrix) rotated in accordance with elevation represent the response variable, and should be joined to <code>random_points</code> (use an inner join).
To complete the response-predictor matrix, extract the values of the environmental predictor raster object to <code>random_points</code>.</p>
<p>E3. Retrieve the bias-reduced RMSE of a random forest and a linear model using spatial cross-validation.
The random forest modeling should include the estimation of optimal hyperparameter combinations (random search with 50 iterations) in an inner tuning loop.
Parallelize the tuning level.
Report the mean RMSE and use a boxplot to visualize all retrieved RMSEs.
Please note that this exercise is best solved using the mlr3 functions <code><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid()</a></code> and <code><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark()</a></code> (see <a href="https://mlr3book.mlr-org.com/perf-eval-cmp.html#benchmarking" class="uri">https://mlr3book.mlr-org.com/perf-eval-cmp.html#benchmarking</a> for more information).</p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="location.html"><span class="header-section-number">14</span> Geomarketing</a></div>
<div class="next"><a href="conclusion.html"><span class="header-section-number">16</span> Conclusion</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <h2>Second Edition</h2>
    <!--<p>Now is a great time to provide feedback</p>-->
        <ul class="list-unstyled">
<!--<li><a href="https://forms.gle/nq9RmbxJyZXQgc948">Provide feedback (5 min)</a></li>--><li><a href="https://geocompx.org/">Visit the geocompx website 🌐</a></li>
          <li><a href="https://r.geocompx.org/#reproducibility">Install updated packages 💾</a></li>
          <li><a href="https://github.com/geocompx/geocompr/issues">Open an issue <i class="fas fa-question"></i></a></li>
          <li><a href="https://discord.gg/PMztXYgNxp">Chat on Discord <i class="fab fa-discord"></i></a></li>
          <li><a href="https://r.geocompx.org/solutions/">Check exercise solutions <i class="fa fa-check"></i></a></li>
          <li><a href="https://supportukrainenow.org/">Support Ukraine 🇺🇦</a></li>
          <li><a href="https://donate.stripe.com/4gweWl94Q9E35AQ6oo">Support this project 💸</a></li>
        </ul>
<hr>
<nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#eco"><span class="header-section-number">15</span> Ecology</a></li>
<li><a class="nav-link" href="#prerequisites-13">Prerequisites</a></li>
<li><a class="nav-link" href="#introduction-9"><span class="header-section-number">15.1</span> Introduction</a></li>
<li><a class="nav-link" href="#data-and-data-preparation"><span class="header-section-number">15.2</span> Data and data preparation</a></li>
<li><a class="nav-link" href="#nmds"><span class="header-section-number">15.3</span> Reducing dimensionality</a></li>
<li>
<a class="nav-link" href="#modeling-the-floristic-gradient"><span class="header-section-number">15.4</span> Modeling the floristic gradient</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mlr3-building-blocks"><span class="header-section-number">15.4.1</span> mlr3 building blocks</a></li>
<li><a class="nav-link" href="#predictive-mapping"><span class="header-section-number">15.4.2</span> Predictive mapping</a></li>
</ul>
</li>
<li><a class="nav-link" href="#conclusions-1"><span class="header-section-number">15.5</span> Conclusions</a></li>
<li><a class="nav-link" href="#exercises-11"><span class="header-section-number">15.6</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/geocompx/geocompr/blob/main/15-eco.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/geocompx/geocompr/edit/main/15-eco.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Geocomputation with R</strong>" was written by Robin Lovelace, Jakub Nowosad, Jannes Muenchow. It was last built on 2025-06-17.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
