<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Spatial data operations | Geocomputation with R</title>
  <meta name="description" content="Chapter 4 Spatial data operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Spatial data operations | Geocomputation with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://geocompr.robinlovelace.net/" />
  <meta property="og:image" content="https://geocompr.robinlovelace.net//images/cover.png" />
  <meta property="og:description" content="Chapter 4 Spatial data operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="github-repo" content="Robinlovelace/geocompr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Spatial data operations | Geocomputation with R" />
  
  <meta name="twitter:description" content="Chapter 4 Spatial data operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="twitter:image" content="https://geocompr.robinlovelace.net//images/cover.png" />

<meta name="author" content="Robin Lovelace, Jakub Nowosad, Jannes Muenchow" />


<meta name="date" content="2021-08-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="attr.html"/>
<link rel="next" href="geometric-operations.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99618359-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Geocomputation with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-contribute"><i class="fa fa-check"></i>How to contribute?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#reproducibility"><i class="fa fa-check"></i>Reproducibility</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#supporting-the-project"><i class="fa fa-check"></i>Supporting the project</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="foreword.html"><a href="foreword.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#how-to-read-this-book"><i class="fa fa-check"></i>How to read this book</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#why-r"><i class="fa fa-check"></i>Why R?</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#real-world-impact"><i class="fa fa-check"></i>Real-world impact</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#what-is-geocomputation"><i class="fa fa-check"></i><b>1.1</b> What is geocomputation?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#why-use-r-for-geocomputation"><i class="fa fa-check"></i><b>1.2</b> Why use R for geocomputation?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#software-for-geocomputation"><i class="fa fa-check"></i><b>1.3</b> Software for geocomputation</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#rs-spatial-ecosystem"><i class="fa fa-check"></i><b>1.4</b> R’s spatial ecosystem</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-history-of-r-spatial"><i class="fa fa-check"></i><b>1.5</b> The history of R-spatial</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>I Foundations</b></span></li>
<li class="chapter" data-level="2" data-path="spatial-class.html"><a href="spatial-class.html"><i class="fa fa-check"></i><b>2</b> Geographic data in R</a><ul>
<li class="chapter" data-level="" data-path="spatial-class.html"><a href="spatial-class.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="spatial-class.html"><a href="spatial-class.html#intro-spatial-class"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="spatial-class.html"><a href="spatial-class.html#vector-data"><i class="fa fa-check"></i><b>2.2</b> Vector data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="spatial-class.html"><a href="spatial-class.html#intro-sf"><i class="fa fa-check"></i><b>2.2.1</b> An introduction to simple features</a></li>
<li class="chapter" data-level="2.2.2" data-path="spatial-class.html"><a href="spatial-class.html#why-simple-features"><i class="fa fa-check"></i><b>2.2.2</b> Why simple features?</a></li>
<li class="chapter" data-level="2.2.3" data-path="spatial-class.html"><a href="spatial-class.html#basic-map"><i class="fa fa-check"></i><b>2.2.3</b> Basic map making</a></li>
<li class="chapter" data-level="2.2.4" data-path="spatial-class.html"><a href="spatial-class.html#base-args"><i class="fa fa-check"></i><b>2.2.4</b> Base plot arguments</a></li>
<li class="chapter" data-level="2.2.5" data-path="spatial-class.html"><a href="spatial-class.html#geometry"><i class="fa fa-check"></i><b>2.2.5</b> Geometry types</a></li>
<li class="chapter" data-level="2.2.6" data-path="spatial-class.html"><a href="spatial-class.html#sfg"><i class="fa fa-check"></i><b>2.2.6</b> Simple feature geometries (sfg)</a></li>
<li class="chapter" data-level="2.2.7" data-path="spatial-class.html"><a href="spatial-class.html#sfc"><i class="fa fa-check"></i><b>2.2.7</b> Simple feature columns (sfc)</a></li>
<li class="chapter" data-level="2.2.8" data-path="spatial-class.html"><a href="spatial-class.html#sf"><i class="fa fa-check"></i><b>2.2.8</b> The sf class</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="spatial-class.html"><a href="spatial-class.html#raster-data"><i class="fa fa-check"></i><b>2.3</b> Raster data</a><ul>
<li class="chapter" data-level="2.3.1" data-path="spatial-class.html"><a href="spatial-class.html#an-introduction-to-raster"><i class="fa fa-check"></i><b>2.3.1</b> An introduction to raster</a></li>
<li class="chapter" data-level="2.3.2" data-path="spatial-class.html"><a href="spatial-class.html#basic-map-raster"><i class="fa fa-check"></i><b>2.3.2</b> Basic map making</a></li>
<li class="chapter" data-level="2.3.3" data-path="spatial-class.html"><a href="spatial-class.html#raster-classes"><i class="fa fa-check"></i><b>2.3.3</b> Raster classes</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="spatial-class.html"><a href="spatial-class.html#crs-intro"><i class="fa fa-check"></i><b>2.4</b> Coordinate Reference Systems</a><ul>
<li class="chapter" data-level="2.4.1" data-path="spatial-class.html"><a href="spatial-class.html#geographic-coordinate-systems"><i class="fa fa-check"></i><b>2.4.1</b> Geographic coordinate systems</a></li>
<li class="chapter" data-level="2.4.2" data-path="spatial-class.html"><a href="spatial-class.html#projected-coordinate-reference-systems"><i class="fa fa-check"></i><b>2.4.2</b> Projected coordinate reference systems</a></li>
<li class="chapter" data-level="2.4.3" data-path="spatial-class.html"><a href="spatial-class.html#crs-in-r"><i class="fa fa-check"></i><b>2.4.3</b> CRSs in R</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="spatial-class.html"><a href="spatial-class.html#units"><i class="fa fa-check"></i><b>2.5</b> Units</a></li>
<li class="chapter" data-level="2.6" data-path="spatial-class.html"><a href="spatial-class.html#ex2"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="attr.html"><a href="attr.html"><i class="fa fa-check"></i><b>3</b> Attribute data operations</a><ul>
<li class="chapter" data-level="" data-path="attr.html"><a href="attr.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="attr.html"><a href="attr.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="attr.html"><a href="attr.html#vector-attribute-manipulation"><i class="fa fa-check"></i><b>3.2</b> Vector attribute manipulation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="attr.html"><a href="attr.html#vector-attribute-subsetting"><i class="fa fa-check"></i><b>3.2.1</b> Vector attribute subsetting</a></li>
<li class="chapter" data-level="3.2.2" data-path="attr.html"><a href="attr.html#vector-attribute-aggregation"><i class="fa fa-check"></i><b>3.2.2</b> Vector attribute aggregation</a></li>
<li class="chapter" data-level="3.2.3" data-path="attr.html"><a href="attr.html#vector-attribute-joining"><i class="fa fa-check"></i><b>3.2.3</b> Vector attribute joining</a></li>
<li class="chapter" data-level="3.2.4" data-path="attr.html"><a href="attr.html#vec-attr-creation"><i class="fa fa-check"></i><b>3.2.4</b> Creating attributes and removing spatial information</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="attr.html"><a href="attr.html#manipulating-raster-objects"><i class="fa fa-check"></i><b>3.3</b> Manipulating raster objects</a><ul>
<li class="chapter" data-level="3.3.1" data-path="attr.html"><a href="attr.html#raster-subsetting"><i class="fa fa-check"></i><b>3.3.1</b> Raster subsetting</a></li>
<li class="chapter" data-level="3.3.2" data-path="attr.html"><a href="attr.html#summarizing-raster-objects"><i class="fa fa-check"></i><b>3.3.2</b> Summarizing raster objects</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="attr.html"><a href="attr.html#exercises-1"><i class="fa fa-check"></i><b>3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-operations.html"><a href="spatial-operations.html"><i class="fa fa-check"></i><b>4</b> Spatial data operations</a><ul>
<li class="chapter" data-level="" data-path="spatial-operations.html"><a href="spatial-operations.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path="spatial-operations.html"><a href="spatial-operations.html#introduction-1"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-vec"><i class="fa fa-check"></i><b>4.2</b> Spatial operations on vector data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-subsetting"><i class="fa fa-check"></i><b>4.2.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.2.2" data-path="spatial-operations.html"><a href="spatial-operations.html#topological-relations"><i class="fa fa-check"></i><b>4.2.2</b> Topological relations</a></li>
<li class="chapter" data-level="4.2.3" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-joining"><i class="fa fa-check"></i><b>4.2.3</b> Spatial joining</a></li>
<li class="chapter" data-level="4.2.4" data-path="spatial-operations.html"><a href="spatial-operations.html#non-overlapping-joins"><i class="fa fa-check"></i><b>4.2.4</b> Non-overlapping joins</a></li>
<li class="chapter" data-level="4.2.5" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-aggr"><i class="fa fa-check"></i><b>4.2.5</b> Spatial data aggregation</a></li>
<li class="chapter" data-level="4.2.6" data-path="spatial-operations.html"><a href="spatial-operations.html#distance-relations"><i class="fa fa-check"></i><b>4.2.6</b> Distance relations</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-ras"><i class="fa fa-check"></i><b>4.3</b> Spatial operations on raster data</a><ul>
<li class="chapter" data-level="4.3.1" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-raster-subsetting"><i class="fa fa-check"></i><b>4.3.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.3.2" data-path="spatial-operations.html"><a href="spatial-operations.html#map-algebra"><i class="fa fa-check"></i><b>4.3.2</b> Map algebra</a></li>
<li class="chapter" data-level="4.3.3" data-path="spatial-operations.html"><a href="spatial-operations.html#local-operations"><i class="fa fa-check"></i><b>4.3.3</b> Local operations</a></li>
<li class="chapter" data-level="4.3.4" data-path="spatial-operations.html"><a href="spatial-operations.html#focal-operations"><i class="fa fa-check"></i><b>4.3.4</b> Focal operations</a></li>
<li class="chapter" data-level="4.3.5" data-path="spatial-operations.html"><a href="spatial-operations.html#zonal-operations"><i class="fa fa-check"></i><b>4.3.5</b> Zonal operations</a></li>
<li class="chapter" data-level="4.3.6" data-path="spatial-operations.html"><a href="spatial-operations.html#global-operations-and-distances"><i class="fa fa-check"></i><b>4.3.6</b> Global operations and distances</a></li>
<li class="chapter" data-level="4.3.7" data-path="spatial-operations.html"><a href="spatial-operations.html#map-algebra-counterparts-in-vector-processing"><i class="fa fa-check"></i><b>4.3.7</b> Map algebra counterparts in vector processing</a></li>
<li class="chapter" data-level="4.3.8" data-path="spatial-operations.html"><a href="spatial-operations.html#merging-rasters"><i class="fa fa-check"></i><b>4.3.8</b> Merging rasters</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="spatial-operations.html"><a href="spatial-operations.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="geometric-operations.html"><a href="geometric-operations.html"><i class="fa fa-check"></i><b>5</b> Geometry operations</a><ul>
<li class="chapter" data-level="" data-path="geometric-operations.html"><a href="geometric-operations.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1" data-path="geometric-operations.html"><a href="geometric-operations.html#introduction-2"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="geometric-operations.html"><a href="geometric-operations.html#geo-vec"><i class="fa fa-check"></i><b>5.2</b> Geometric operations on vector data</a><ul>
<li class="chapter" data-level="5.2.1" data-path="geometric-operations.html"><a href="geometric-operations.html#simplification"><i class="fa fa-check"></i><b>5.2.1</b> Simplification</a></li>
<li class="chapter" data-level="5.2.2" data-path="geometric-operations.html"><a href="geometric-operations.html#centroids"><i class="fa fa-check"></i><b>5.2.2</b> Centroids</a></li>
<li class="chapter" data-level="5.2.3" data-path="geometric-operations.html"><a href="geometric-operations.html#buffers"><i class="fa fa-check"></i><b>5.2.3</b> Buffers</a></li>
<li class="chapter" data-level="5.2.4" data-path="geometric-operations.html"><a href="geometric-operations.html#affine-transformations"><i class="fa fa-check"></i><b>5.2.4</b> Affine transformations</a></li>
<li class="chapter" data-level="5.2.5" data-path="geometric-operations.html"><a href="geometric-operations.html#clipping"><i class="fa fa-check"></i><b>5.2.5</b> Clipping</a></li>
<li class="chapter" data-level="5.2.6" data-path="geometric-operations.html"><a href="geometric-operations.html#geometry-unions"><i class="fa fa-check"></i><b>5.2.6</b> Geometry unions</a></li>
<li class="chapter" data-level="5.2.7" data-path="geometric-operations.html"><a href="geometric-operations.html#type-trans"><i class="fa fa-check"></i><b>5.2.7</b> Type transformations</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="geometric-operations.html"><a href="geometric-operations.html#geo-ras"><i class="fa fa-check"></i><b>5.3</b> Geometric operations on raster data</a><ul>
<li class="chapter" data-level="5.3.1" data-path="geometric-operations.html"><a href="geometric-operations.html#geometric-intersections"><i class="fa fa-check"></i><b>5.3.1</b> Geometric intersections</a></li>
<li class="chapter" data-level="5.3.2" data-path="geometric-operations.html"><a href="geometric-operations.html#extent-and-origin"><i class="fa fa-check"></i><b>5.3.2</b> Extent and origin</a></li>
<li class="chapter" data-level="5.3.3" data-path="geometric-operations.html"><a href="geometric-operations.html#aggregation-and-disaggregation"><i class="fa fa-check"></i><b>5.3.3</b> Aggregation and disaggregation</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-vector"><i class="fa fa-check"></i><b>5.4</b> Raster-vector interactions</a><ul>
<li class="chapter" data-level="5.4.1" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-cropping"><i class="fa fa-check"></i><b>5.4.1</b> Raster cropping</a></li>
<li class="chapter" data-level="5.4.2" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-extraction"><i class="fa fa-check"></i><b>5.4.2</b> Raster extraction</a></li>
<li class="chapter" data-level="5.4.3" data-path="geometric-operations.html"><a href="geometric-operations.html#rasterization"><i class="fa fa-check"></i><b>5.4.3</b> Rasterization</a></li>
<li class="chapter" data-level="5.4.4" data-path="geometric-operations.html"><a href="geometric-operations.html#spatial-vectorization"><i class="fa fa-check"></i><b>5.4.4</b> Spatial vectorization</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="geometric-operations.html"><a href="geometric-operations.html#exercises-3"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html"><i class="fa fa-check"></i><b>6</b> Reprojecting geographic data</a><ul>
<li class="chapter" data-level="" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#introduction-3"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#when-to-reproject"><i class="fa fa-check"></i><b>6.2</b> When to reproject?</a></li>
<li class="chapter" data-level="6.3" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#which-crs-to-use"><i class="fa fa-check"></i><b>6.3</b> Which CRS to use?</a></li>
<li class="chapter" data-level="6.4" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#reproj-vec-geom"><i class="fa fa-check"></i><b>6.4</b> Reprojecting vector geometries</a></li>
<li class="chapter" data-level="6.5" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#modifying-map-projections"><i class="fa fa-check"></i><b>6.5</b> Modifying map projections</a></li>
<li class="chapter" data-level="6.6" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#reprojecting-raster-geometries"><i class="fa fa-check"></i><b>6.6</b> Reprojecting raster geometries</a></li>
<li class="chapter" data-level="6.7" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#exercises-4"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="read-write.html"><a href="read-write.html"><i class="fa fa-check"></i><b>7</b> Geographic data I/O</a><ul>
<li class="chapter" data-level="" data-path="read-write.html"><a href="read-write.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="7.1" data-path="read-write.html"><a href="read-write.html#introduction-4"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="read-write.html"><a href="read-write.html#retrieving-data"><i class="fa fa-check"></i><b>7.2</b> Retrieving open data</a></li>
<li class="chapter" data-level="7.3" data-path="read-write.html"><a href="read-write.html#geographic-data-packages"><i class="fa fa-check"></i><b>7.3</b> Geographic data packages</a></li>
<li class="chapter" data-level="7.4" data-path="read-write.html"><a href="read-write.html#geographic-web-services"><i class="fa fa-check"></i><b>7.4</b> Geographic web services</a></li>
<li class="chapter" data-level="7.5" data-path="read-write.html"><a href="read-write.html#file-formats"><i class="fa fa-check"></i><b>7.5</b> File formats</a></li>
<li class="chapter" data-level="7.6" data-path="read-write.html"><a href="read-write.html#data-input"><i class="fa fa-check"></i><b>7.6</b> Data input (I)</a><ul>
<li class="chapter" data-level="7.6.1" data-path="read-write.html"><a href="read-write.html#vector-data-1"><i class="fa fa-check"></i><b>7.6.1</b> Vector data</a></li>
<li class="chapter" data-level="7.6.2" data-path="read-write.html"><a href="read-write.html#raster-data-1"><i class="fa fa-check"></i><b>7.6.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="read-write.html"><a href="read-write.html#data-output"><i class="fa fa-check"></i><b>7.7</b> Data output (O)</a><ul>
<li class="chapter" data-level="7.7.1" data-path="read-write.html"><a href="read-write.html#vector-data-2"><i class="fa fa-check"></i><b>7.7.1</b> Vector data</a></li>
<li class="chapter" data-level="7.7.2" data-path="read-write.html"><a href="read-write.html#raster-data-2"><i class="fa fa-check"></i><b>7.7.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="read-write.html"><a href="read-write.html#visual-outputs"><i class="fa fa-check"></i><b>7.8</b> Visual outputs</a></li>
<li class="chapter" data-level="7.9" data-path="read-write.html"><a href="read-write.html#exercises-5"><i class="fa fa-check"></i><b>7.9</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Extensions</b></span></li>
<li class="chapter" data-level="8" data-path="adv-map.html"><a href="adv-map.html"><i class="fa fa-check"></i><b>8</b> Making maps with R</a><ul>
<li class="chapter" data-level="" data-path="adv-map.html"><a href="adv-map.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="8.1" data-path="adv-map.html"><a href="adv-map.html#introduction-5"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="adv-map.html"><a href="adv-map.html#static-maps"><i class="fa fa-check"></i><b>8.2</b> Static maps</a><ul>
<li class="chapter" data-level="8.2.1" data-path="adv-map.html"><a href="adv-map.html#tmap-basics"><i class="fa fa-check"></i><b>8.2.1</b> tmap basics</a></li>
<li class="chapter" data-level="8.2.2" data-path="adv-map.html"><a href="adv-map.html#map-obj"><i class="fa fa-check"></i><b>8.2.2</b> Map objects</a></li>
<li class="chapter" data-level="8.2.3" data-path="adv-map.html"><a href="adv-map.html#aesthetics"><i class="fa fa-check"></i><b>8.2.3</b> Aesthetics</a></li>
<li class="chapter" data-level="8.2.4" data-path="adv-map.html"><a href="adv-map.html#color-settings"><i class="fa fa-check"></i><b>8.2.4</b> Color settings</a></li>
<li class="chapter" data-level="8.2.5" data-path="adv-map.html"><a href="adv-map.html#layouts"><i class="fa fa-check"></i><b>8.2.5</b> Layouts</a></li>
<li class="chapter" data-level="8.2.6" data-path="adv-map.html"><a href="adv-map.html#faceted-maps"><i class="fa fa-check"></i><b>8.2.6</b> Faceted maps</a></li>
<li class="chapter" data-level="8.2.7" data-path="adv-map.html"><a href="adv-map.html#inset-maps"><i class="fa fa-check"></i><b>8.2.7</b> Inset maps</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="adv-map.html"><a href="adv-map.html#animated-maps"><i class="fa fa-check"></i><b>8.3</b> Animated maps</a></li>
<li class="chapter" data-level="8.4" data-path="adv-map.html"><a href="adv-map.html#interactive-maps"><i class="fa fa-check"></i><b>8.4</b> Interactive maps</a></li>
<li class="chapter" data-level="8.5" data-path="adv-map.html"><a href="adv-map.html#mapping-applications"><i class="fa fa-check"></i><b>8.5</b> Mapping applications</a></li>
<li class="chapter" data-level="8.6" data-path="adv-map.html"><a href="adv-map.html#other-mapping-packages"><i class="fa fa-check"></i><b>8.6</b> Other mapping packages</a></li>
<li class="chapter" data-level="8.7" data-path="adv-map.html"><a href="adv-map.html#exercises-6"><i class="fa fa-check"></i><b>8.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="gis.html"><a href="gis.html"><i class="fa fa-check"></i><b>9</b> Bridges to GIS software</a><ul>
<li class="chapter" data-level="" data-path="gis.html"><a href="gis.html#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="9.1" data-path="gis.html"><a href="gis.html#introduction-6"><i class="fa fa-check"></i><b>9.1</b> Introduction</a></li>
<li class="chapter" data-level="9.2" data-path="gis.html"><a href="gis.html#rqgis"><i class="fa fa-check"></i><b>9.2</b> (R)QGIS</a></li>
<li class="chapter" data-level="9.3" data-path="gis.html"><a href="gis.html#rsaga"><i class="fa fa-check"></i><b>9.3</b> (R)SAGA</a></li>
<li class="chapter" data-level="9.4" data-path="gis.html"><a href="gis.html#rgrass"><i class="fa fa-check"></i><b>9.4</b> GRASS through <strong>rgrass7</strong></a></li>
<li class="chapter" data-level="9.5" data-path="gis.html"><a href="gis.html#when-to-use-what"><i class="fa fa-check"></i><b>9.5</b> When to use what?</a></li>
<li class="chapter" data-level="9.6" data-path="gis.html"><a href="gis.html#other-bridges"><i class="fa fa-check"></i><b>9.6</b> Other bridges</a><ul>
<li class="chapter" data-level="9.6.1" data-path="gis.html"><a href="gis.html#gdal"><i class="fa fa-check"></i><b>9.6.1</b> Bridges to GDAL</a></li>
<li class="chapter" data-level="9.6.2" data-path="gis.html"><a href="gis.html#postgis"><i class="fa fa-check"></i><b>9.6.2</b> Bridges to spatial databases</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="gis.html"><a href="gis.html#exercises-7"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="algorithms.html"><a href="algorithms.html"><i class="fa fa-check"></i><b>10</b> Scripts, algorithms and functions</a><ul>
<li class="chapter" data-level="" data-path="algorithms.html"><a href="algorithms.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="10.1" data-path="algorithms.html"><a href="algorithms.html#intro-algorithms"><i class="fa fa-check"></i><b>10.1</b> Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="algorithms.html"><a href="algorithms.html#scripts"><i class="fa fa-check"></i><b>10.2</b> Scripts</a></li>
<li class="chapter" data-level="10.3" data-path="algorithms.html"><a href="algorithms.html#geometric-algorithms"><i class="fa fa-check"></i><b>10.3</b> Geometric algorithms</a></li>
<li class="chapter" data-level="10.4" data-path="algorithms.html"><a href="algorithms.html#functions"><i class="fa fa-check"></i><b>10.4</b> Functions</a></li>
<li class="chapter" data-level="10.5" data-path="algorithms.html"><a href="algorithms.html#programming"><i class="fa fa-check"></i><b>10.5</b> Programming</a></li>
<li class="chapter" data-level="10.6" data-path="algorithms.html"><a href="algorithms.html#ex-algorithms"><i class="fa fa-check"></i><b>10.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="spatial-cv.html"><a href="spatial-cv.html"><i class="fa fa-check"></i><b>11</b> Statistical learning</a><ul>
<li class="chapter" data-level="" data-path="spatial-cv.html"><a href="spatial-cv.html#prerequisites-9"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="11.1" data-path="spatial-cv.html"><a href="spatial-cv.html#intro-cv1"><i class="fa fa-check"></i><b>11.1</b> Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="spatial-cv.html"><a href="spatial-cv.html#case-landslide"><i class="fa fa-check"></i><b>11.2</b> Case study: Landslide susceptibility</a></li>
<li class="chapter" data-level="11.3" data-path="spatial-cv.html"><a href="spatial-cv.html#conventional-model"><i class="fa fa-check"></i><b>11.3</b> Conventional modeling approach in R</a></li>
<li class="chapter" data-level="11.4" data-path="spatial-cv.html"><a href="spatial-cv.html#intro-cv"><i class="fa fa-check"></i><b>11.4</b> Introduction to (spatial) cross-validation</a></li>
<li class="chapter" data-level="11.5" data-path="spatial-cv.html"><a href="spatial-cv.html#spatial-cv-with-mlr"><i class="fa fa-check"></i><b>11.5</b> Spatial CV with <strong>mlr</strong></a><ul>
<li class="chapter" data-level="11.5.1" data-path="spatial-cv.html"><a href="spatial-cv.html#glm"><i class="fa fa-check"></i><b>11.5.1</b> Generalized linear model</a></li>
<li class="chapter" data-level="11.5.2" data-path="spatial-cv.html"><a href="spatial-cv.html#svm"><i class="fa fa-check"></i><b>11.5.2</b> Spatial tuning of machine-learning hyperparameters</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="spatial-cv.html"><a href="spatial-cv.html#conclusions"><i class="fa fa-check"></i><b>11.6</b> Conclusions</a></li>
<li class="chapter" data-level="11.7" data-path="spatial-cv.html"><a href="spatial-cv.html#exercises-8"><i class="fa fa-check"></i><b>11.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Applications</b></span></li>
<li class="chapter" data-level="12" data-path="transport.html"><a href="transport.html"><i class="fa fa-check"></i><b>12</b> Transportation</a><ul>
<li class="chapter" data-level="" data-path="transport.html"><a href="transport.html#prerequisites-10"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="12.1" data-path="transport.html"><a href="transport.html#introduction-7"><i class="fa fa-check"></i><b>12.1</b> Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="transport.html"><a href="transport.html#bris-case"><i class="fa fa-check"></i><b>12.2</b> A case study of Bristol</a></li>
<li class="chapter" data-level="12.3" data-path="transport.html"><a href="transport.html#transport-zones"><i class="fa fa-check"></i><b>12.3</b> Transport zones</a></li>
<li class="chapter" data-level="12.4" data-path="transport.html"><a href="transport.html#desire-lines"><i class="fa fa-check"></i><b>12.4</b> Desire lines</a></li>
<li class="chapter" data-level="12.5" data-path="transport.html"><a href="transport.html#routes"><i class="fa fa-check"></i><b>12.5</b> Routes</a></li>
<li class="chapter" data-level="12.6" data-path="transport.html"><a href="transport.html#nodes"><i class="fa fa-check"></i><b>12.6</b> Nodes</a></li>
<li class="chapter" data-level="12.7" data-path="transport.html"><a href="transport.html#route-networks"><i class="fa fa-check"></i><b>12.7</b> Route networks</a></li>
<li class="chapter" data-level="12.8" data-path="transport.html"><a href="transport.html#prioritizing-new-infrastructure"><i class="fa fa-check"></i><b>12.8</b> Prioritizing new infrastructure</a></li>
<li class="chapter" data-level="12.9" data-path="transport.html"><a href="transport.html#future-directions-of-travel"><i class="fa fa-check"></i><b>12.9</b> Future directions of travel</a></li>
<li class="chapter" data-level="12.10" data-path="transport.html"><a href="transport.html#ex-transport"><i class="fa fa-check"></i><b>12.10</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="location.html"><a href="location.html"><i class="fa fa-check"></i><b>13</b> Geomarketing</a><ul>
<li class="chapter" data-level="" data-path="location.html"><a href="location.html#prerequisites-11"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="13.1" data-path="location.html"><a href="location.html#introduction-8"><i class="fa fa-check"></i><b>13.1</b> Introduction</a></li>
<li class="chapter" data-level="13.2" data-path="location.html"><a href="location.html#case-study"><i class="fa fa-check"></i><b>13.2</b> Case study: bike shops in Germany</a></li>
<li class="chapter" data-level="13.3" data-path="location.html"><a href="location.html#tidy-the-input-data"><i class="fa fa-check"></i><b>13.3</b> Tidy the input data</a></li>
<li class="chapter" data-level="13.4" data-path="location.html"><a href="location.html#create-census-rasters"><i class="fa fa-check"></i><b>13.4</b> Create census rasters</a></li>
<li class="chapter" data-level="13.5" data-path="location.html"><a href="location.html#define-metropolitan-areas"><i class="fa fa-check"></i><b>13.5</b> Define metropolitan areas</a></li>
<li class="chapter" data-level="13.6" data-path="location.html"><a href="location.html#points-of-interest"><i class="fa fa-check"></i><b>13.6</b> Points of interest</a></li>
<li class="chapter" data-level="13.7" data-path="location.html"><a href="location.html#identifying-suitable-locations"><i class="fa fa-check"></i><b>13.7</b> Identifying suitable locations</a></li>
<li class="chapter" data-level="13.8" data-path="location.html"><a href="location.html#discussion-and-next-steps"><i class="fa fa-check"></i><b>13.8</b> Discussion and next steps</a></li>
<li class="chapter" data-level="13.9" data-path="location.html"><a href="location.html#exercises-9"><i class="fa fa-check"></i><b>13.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="eco.html"><a href="eco.html"><i class="fa fa-check"></i><b>14</b> Ecology</a><ul>
<li class="chapter" data-level="" data-path="eco.html"><a href="eco.html#prerequisites-12"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="14.1" data-path="eco.html"><a href="eco.html#introduction-9"><i class="fa fa-check"></i><b>14.1</b> Introduction</a></li>
<li class="chapter" data-level="14.2" data-path="eco.html"><a href="eco.html#data-and-data-preparation"><i class="fa fa-check"></i><b>14.2</b> Data and data preparation</a></li>
<li class="chapter" data-level="14.3" data-path="eco.html"><a href="eco.html#nmds"><i class="fa fa-check"></i><b>14.3</b> Reducing dimensionality</a></li>
<li class="chapter" data-level="14.4" data-path="eco.html"><a href="eco.html#modeling-the-floristic-gradient"><i class="fa fa-check"></i><b>14.4</b> Modeling the floristic gradient</a><ul>
<li class="chapter" data-level="14.4.1" data-path="eco.html"><a href="eco.html#mlr-building-blocks"><i class="fa fa-check"></i><b>14.4.1</b> <strong>mlr</strong> building blocks</a></li>
<li class="chapter" data-level="14.4.2" data-path="eco.html"><a href="eco.html#predictive-mapping"><i class="fa fa-check"></i><b>14.4.2</b> Predictive mapping</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="eco.html"><a href="eco.html#conclusions-1"><i class="fa fa-check"></i><b>14.5</b> Conclusions</a></li>
<li class="chapter" data-level="14.6" data-path="eco.html"><a href="eco.html#exercises-10"><i class="fa fa-check"></i><b>14.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>15</b> Conclusion</a><ul>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html#prerequisites-13"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="15.1" data-path="conclusion.html"><a href="conclusion.html#introduction-10"><i class="fa fa-check"></i><b>15.1</b> Introduction</a></li>
<li class="chapter" data-level="15.2" data-path="conclusion.html"><a href="conclusion.html#package-choice"><i class="fa fa-check"></i><b>15.2</b> Package choice</a></li>
<li class="chapter" data-level="15.3" data-path="conclusion.html"><a href="conclusion.html#gaps"><i class="fa fa-check"></i><b>15.3</b> Gaps and overlaps</a></li>
<li class="chapter" data-level="15.4" data-path="conclusion.html"><a href="conclusion.html#next"><i class="fa fa-check"></i><b>15.4</b> Where to go next?</a></li>
<li class="chapter" data-level="15.5" data-path="conclusion.html"><a href="conclusion.html#benefit"><i class="fa fa-check"></i><b>15.5</b> The open source approach</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://robinlovelace.net/">Robin Lovelace</a></li>
<li><a href="https://nowosad.github.io/">Jakub Nowosad</a></li>
<li><a href="https://github.com/jannes-m/">Jannes Muenchow</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Geocomputation with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-operations" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Spatial data operations</h1>
<div id="prerequisites-2" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<ul>
<li>This chapter requires the same packages used in Chapter <a href="attr.html#attr">3</a>:</li>
</ul>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="spatial-operations.html#cb112-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb112-2"><a href="spatial-operations.html#cb112-2"></a><span class="kw">library</span>(raster)</span>
<span id="cb112-3"><a href="spatial-operations.html#cb112-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb112-4"><a href="spatial-operations.html#cb112-4"></a><span class="kw">library</span>(spData)</span></code></pre></div>
</div>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<p>Spatial operations are a vital part of geocomputation.
This chapter shows how spatial objects can be modified in a multitude of ways based on their location and shape.
The content builds on the previous chapter because many spatial operations have a non-spatial (attribute) equivalent.
This is especially true for <em>vector</em> operations: Section <a href="attr.html#vector-attribute-manipulation">3.2</a> on vector attribute manipulation provides the basis for understanding its spatial counterpart, namely spatial subsetting (covered in Section <a href="spatial-operations.html#spatial-subsetting">4.2.1</a>).
Spatial joining (Section <a href="spatial-operations.html#spatial-joining">4.2.3</a>) and aggregation (Section <a href="spatial-operations.html#spatial-aggr">4.2.5</a>) also have non-spatial counterparts, covered in the previous chapter.</p>
<p>Spatial operations differ from non-spatial operations in some ways, however.
To illustrate the point, imagine you are researching road safety.
Spatial joins can be used to find road speed limits related with administrative zones, even when no zone ID is provided.
But this raises the question: should the road completely fall inside a zone for its values to be joined?
Or is simply crossing or being within a certain distance sufficient?
When posing such questions, it becomes apparent that spatial operations differ substantially from attribute operations on data frames:
the <em>type</em> of spatial relationship between objects must be considered.
These are covered in Section <a href="spatial-operations.html#topological-relations">4.2.2</a>, on topological relations.</p>
<p>
Another unique aspect of spatial objects is distance.
All spatial objects are related through space, and distance calculations can be used to explore the strength of this relationship. These are covered in Section <a href="spatial-operations.html#distance-relations">4.2.6</a>.</p>
<p>Spatial operations also apply to raster objects.
Spatial subsetting of raster objects is covered in Section <a href="spatial-operations.html#spatial-raster-subsetting">4.3.1</a>; merging several raster ‘tiles’ into a single object is covered in Section <a href="spatial-operations.html#merging-rasters">4.3.8</a>.
For many applications, the most important spatial operation on raster objects is <em>map algebra</em>, as we will see in Sections <a href="spatial-operations.html#map-algebra">4.3.2</a> to <a href="spatial-operations.html#global-operations-and-distances">4.3.6</a>.
Map algebra is also the prerequisite for distance calculations on rasters, a technique which is covered in Section <a href="spatial-operations.html#global-operations-and-distances">4.3.6</a>.</p>

<div class="rmdnote">
It is important to note that spatial operations that use two spatial objects rely on both objects having the same coordinate reference system, a topic that was introduced in Section <a href="spatial-class.html#crs-intro">2.4</a> and which will be covered in more depth in Chapter <a href="reproj-geo-data.html#reproj-geo-data">6</a>.
</div>

</div>
<div id="spatial-vec" class="section level2">
<h2><span class="header-section-number">4.2</span> Spatial operations on vector data</h2>
<p>This section provides an overview of spatial operations on vector geographic data represented as simple features in the <strong>sf</strong> package before Section <a href="spatial-operations.html#spatial-ras">4.3</a>, which presents spatial methods using the <strong>raster</strong> package.</p>
<div id="spatial-subsetting" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Spatial subsetting</h3>
<p>Spatial subsetting is the process of selecting features of a spatial object based on whether or not they in some way <em>relate</em> in space to another object.
It is analogous to <em>attribute subsetting</em> (covered in Section <a href="attr.html#vector-attribute-subsetting">3.2.1</a>) and can be done with the base R square bracket (<code>[</code>) operator or with the <code>filter()</code> function from the <strong>tidyverse</strong>.

</p>
<p>An example of spatial subsetting is provided by the <code>nz</code> and <code>nz_height</code> datasets in <strong>spData</strong>.
These contain projected data on the 16 main regions and 101 highest points in New Zealand, respectively (Figure <a href="spatial-operations.html#fig:nz-subset">4.1</a>).
The following code chunk first creates an object representing Canterbury, then uses spatial subsetting to return all high points in the region:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="spatial-operations.html#cb113-1"></a>canterbury =<span class="st"> </span>nz <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Name <span class="op">==</span><span class="st"> &quot;Canterbury&quot;</span>)</span>
<span id="cb113-2"><a href="spatial-operations.html#cb113-2"></a>canterbury_height =<span class="st"> </span>nz_height[canterbury, ]</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:nz-subset"></span>
<img src="04-spatial-operations_files/figure-html/nz-subset-1.png" alt="Illustration of spatial subsetting with red triangles representing 101 high points in New Zealand, clustered near the central Canterbuy region (left). The points in Canterbury were created with the `[` subsetting operator (highlighted in gray, right)." width="100%" />
<p class="caption">
FIGURE 4.1: Illustration of spatial subsetting with red triangles representing 101 high points in New Zealand, clustered near the central Canterbuy region (left). The points in Canterbury were created with the <code>[</code> subsetting operator (highlighted in gray, right).
</p>
</div>
<p>Like attribute subsetting <code>x[y, ]</code> subsets features of a <em>target</em> <code>x</code> using the contents of a <em>source</em> object <code>y</code>.
Instead of <code>y</code> being of class <code>logical</code> or <code>integer</code> — a vector of <code>TRUE</code> and <code>FALSE</code> values or whole numbers — for spatial subsetting it is another spatial (<code>sf</code>) object.</p>
<p>Various <em>topological relations</em> can be used for spatial subsetting.
These determine the type of spatial relationship that features in the target object must have with the subsetting object to be selected, including <em>touches</em>, <em>crosses</em> or <em>within</em> (see Section <a href="spatial-operations.html#topological-relations">4.2.2</a>).
<em>Intersects</em> is the default spatial subsetting operator, a default that returns <code>TRUE</code> for many types of spatial relations, including <em>touches</em>, <em>crosses</em> and <em>is within</em>.
These alternative spatial operators can be specified with the <code>op =</code> argument, a third argument that can be passed to the <code>[</code> operator for <code>sf</code> objects.
This is demonstrated in the following command which returns the opposite of <code>st_intersects()</code>, points that do not intersect with Canterbury (see Section <a href="spatial-operations.html#topological-relations">4.2.2</a>):</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="spatial-operations.html#cb114-1"></a>nz_height[canterbury, , op =<span class="st"> </span>st_disjoint]</span></code></pre></div>

<div class="rmdnote">
Note the empty argument — denoted with <code>, ,</code> — in the preceding code chunk is included to highlight <code>op</code>, the third argument in <code>[</code> for <code>sf</code> objects.
One can use this to change the subsetting operation in many ways.
<code>nz_height[canterbury, 2, op = st_disjoint]</code>, for example, returns the same rows but only includes the second attribute column (see <code>sf:::`[.sf`</code> and the <code>?sf</code> for details).
</div>

<p>For many applications, this is all you’ll need to know about spatial subsetting for vector data.
In this case, you can safely skip to Section <a href="spatial-operations.html#topological-relations">4.2.2</a>.</p>
<p>If you’re interested in the details, including other ways of subsetting, read on.
Another way of doing spatial subsetting uses objects returned by <em>topological operators</em>.
This is demonstrated in the first command below:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="spatial-operations.html#cb115-1"></a>sel_sgbp =<span class="st"> </span><span class="kw">st_intersects</span>(<span class="dt">x =</span> nz_height, <span class="dt">y =</span> canterbury)</span>
<span id="cb115-2"><a href="spatial-operations.html#cb115-2"></a><span class="kw">class</span>(sel_sgbp)</span>
<span id="cb115-3"><a href="spatial-operations.html#cb115-3"></a><span class="co">#&gt; [1] &quot;sgbp&quot; &quot;list&quot;</span></span>
<span id="cb115-4"><a href="spatial-operations.html#cb115-4"></a>sel_logical =<span class="st"> </span><span class="kw">lengths</span>(sel_sgbp) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb115-5"><a href="spatial-operations.html#cb115-5"></a>canterbury_height2 =<span class="st"> </span>nz_height[sel_logical, ]</span></code></pre></div>
<p>In the above code chunk, an object of class <code>sgbp</code> (a sparse geometry binary predicate, a list of length <code>x</code> in the spatial operation) is created and then converted into a logical vector <code>sel_logical</code> (containing only <code>TRUE</code> and <code>FALSE</code> values).

The function <code>lengths()</code> identifies which features in <code>nz_height</code> intersect with <em>any</em> objects in <code>y</code>.
In this case 1 is the greatest possible value but for more complex operations one could use the method to subset only features that intersect with, for example, 2 or more features from the source object.</p>

<div class="rmdnote">
Note: another way to return a logical output is by setting <code>sparse = FALSE</code> (meaning ‘return a dense matrix not a sparse one’) in operators such as <code>st_intersects()</code>. The command <code>st_intersects(x = nz_height, y = canterbury, sparse = FALSE)[, 1]</code>, for example, would return an output identical to <code>sel_logical</code>.
Note: the solution involving <code>sgbp</code> objects is more generalisable though, as it works for many-to-many operations and has lower memory requirements.
</div>

<p>It should be noted that a logical can also be used with <code>filter()</code> as follows (<code>sparse = FALSE</code> is explained in Section <a href="spatial-operations.html#topological-relations">4.2.2</a>):</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="spatial-operations.html#cb116-1"></a>canterbury_height3 =<span class="st"> </span>nz_height <span class="op">%&gt;%</span></span>
<span id="cb116-2"><a href="spatial-operations.html#cb116-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">st_intersects</span>(<span class="dt">x =</span> ., <span class="dt">y =</span> canterbury, <span class="dt">sparse =</span> <span class="ot">FALSE</span>))</span></code></pre></div>
<p>At this point, there are three versions of <code>canterbury_height</code>, one created with spatial subsetting directly and the other two via intermediary selection objects.
To explore these objects and spatial subsetting in more detail, see the supplementary vignettes on <code>subsetting</code> and <a href="https://geocompr.github.io/geocompkg/articles/"><code>tidyverse-pitfalls</code></a>.</p>
</div>
<div id="topological-relations" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Topological relations</h3>
<!-- http://lin-ear-th-inking.blogspot.com/2007/06/subtleties-of-ogc-covers-spatial.html -->
<!-- https://edzer.github.io/sfr/articles/sf3.html -->
<!-- https://github.com/edzer/sfr/wiki/migrating#relevant-commands-exported-by-rgeos -->
<!-- Relations and inverse relations -->
<!-- http://desktop.arcgis.com/en/arcmap/latest/extensions/data-reviewer/types-of-spatial-relationships-that-can-be-validated.htm -->
<!-- Topological relations: + difference between datatypes -->
<!-- ?geos_binary_pred -->
<!-- Distance relations -->
<!-- Subset (1) points in polygons <-> (2) -->
<p>Topological relations describe the spatial relationships between objects.
To understand them, it helps to have some simple test data to work with.
Figure <a href="spatial-operations.html#fig:relation-objects">4.2</a> contains a polygon (<code>a</code>), a line (<code>l</code>) and some points (<code>p</code>), which are created in the code below.
</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="spatial-operations.html#cb117-1"></a><span class="co"># create a polygon</span></span>
<span id="cb117-2"><a href="spatial-operations.html#cb117-2"></a>a_poly =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-1</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">-1</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-1</span>))))</span>
<span id="cb117-3"><a href="spatial-operations.html#cb117-3"></a>a =<span class="st"> </span><span class="kw">st_sfc</span>(a_poly)</span>
<span id="cb117-4"><a href="spatial-operations.html#cb117-4"></a><span class="co"># create a line</span></span>
<span id="cb117-5"><a href="spatial-operations.html#cb117-5"></a>l_line =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="dt">x =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-1</span>, <span class="fl">-0.5</span>, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb117-6"><a href="spatial-operations.html#cb117-6"></a>l =<span class="st"> </span><span class="kw">st_sfc</span>(l_line)</span>
<span id="cb117-7"><a href="spatial-operations.html#cb117-7"></a><span class="co"># create points</span></span>
<span id="cb117-8"><a href="spatial-operations.html#cb117-8"></a>p_matrix =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">-1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb117-9"><a href="spatial-operations.html#cb117-9"></a>p_multi =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="dt">x =</span> p_matrix)</span>
<span id="cb117-10"><a href="spatial-operations.html#cb117-10"></a>p =<span class="st"> </span><span class="kw">st_cast</span>(<span class="kw">st_sfc</span>(p_multi), <span class="st">&quot;POINT&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:relation-objects"></span>
<img src="04-spatial-operations_files/figure-html/relation-objects-1.png" alt="Points (p 1 to 4), line and polygon objects arranged to illustrate topological relations." width="50%" />
<p class="caption">
FIGURE 4.2: Points (p 1 to 4), line and polygon objects arranged to illustrate topological relations.
</p>
</div>
<p>A simple query is: which of the points in <code>p</code> intersect in some way with polygon <code>a</code>?
The question can be answered by inspection (points 1 and 2 are over or touch the triangle).
It can also be answered by using a <em>spatial predicate</em> such as <em>do the objects intersect</em>?
This is implemented in <strong>sf</strong> as follows:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="spatial-operations.html#cb118-1"></a><span class="kw">st_intersects</span>(p, a)</span>
<span id="cb118-2"><a href="spatial-operations.html#cb118-2"></a><span class="co">#&gt; Sparse geometry binary ..., where the predicate was `intersects&#39;</span></span>
<span id="cb118-3"><a href="spatial-operations.html#cb118-3"></a><span class="co">#&gt; 1: 1</span></span>
<span id="cb118-4"><a href="spatial-operations.html#cb118-4"></a><span class="co">#&gt; 2: 1</span></span>
<span id="cb118-5"><a href="spatial-operations.html#cb118-5"></a><span class="co">#&gt; 3: (empty)</span></span>
<span id="cb118-6"><a href="spatial-operations.html#cb118-6"></a><span class="co">#&gt; 4: (empty)</span></span></code></pre></div>
<p>The contents of the result should be as you expected:
the function returns a positive (<code>1</code>) result for the first two points, and a negative result (represented by an empty vector) for the last two.
What may be unexpected is that the result comes in the form of a list of vectors.
This <em>sparse matrix</em> output only registers a relation if one exists, reducing the memory requirements of topological operations on multi-feature objects.
As we saw in the previous section, a <em>dense matrix</em> consisting of <code>TRUE</code> or <code>FALSE</code> values for each combination of features can also be returned when <code>sparse = FALSE</code>:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="spatial-operations.html#cb119-1"></a><span class="kw">st_intersects</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)</span>
<span id="cb119-2"><a href="spatial-operations.html#cb119-2"></a><span class="co">#&gt;       [,1]</span></span>
<span id="cb119-3"><a href="spatial-operations.html#cb119-3"></a><span class="co">#&gt; [1,]  TRUE</span></span>
<span id="cb119-4"><a href="spatial-operations.html#cb119-4"></a><span class="co">#&gt; [2,]  TRUE</span></span>
<span id="cb119-5"><a href="spatial-operations.html#cb119-5"></a><span class="co">#&gt; [3,] FALSE</span></span>
<span id="cb119-6"><a href="spatial-operations.html#cb119-6"></a><span class="co">#&gt; [4,] FALSE</span></span></code></pre></div>
<p>The output is a matrix in which each row represents a feature in the target object and each column represents a feature in the selecting object.
In this case, only the first two features in <code>p</code> intersect with <code>a</code> and there is only one feature in <code>a</code> so the result has only one column.
The result can be used for subsetting as we saw in Section <a href="spatial-operations.html#spatial-subsetting">4.2.1</a>.</p>
<p>Note that <code>st_intersects()</code> returns <code>TRUE</code> for the second feature in the object <code>p</code> even though it just touches the polygon <code>a</code>: <em>intersects</em> is a ‘catch-all’ topological operation which identifies many types of spatial relation.</p>
<p>The opposite of <code>st_intersects()</code> is <code>st_disjoint()</code>, which returns only objects that do not spatially relate in any way to the selecting object (note <code>[, 1]</code> converts the result into a vector):</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="spatial-operations.html#cb120-1"></a><span class="kw">st_disjoint</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb120-2"><a href="spatial-operations.html#cb120-2"></a><span class="co">#&gt; [1] FALSE FALSE  TRUE  TRUE</span></span></code></pre></div>
<p><code>st_within()</code> returns <code>TRUE</code> only for objects that are completely within the selecting object.
This applies only to the first object, which is inside the triangular polygon, as illustrated below:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="spatial-operations.html#cb121-1"></a><span class="kw">st_within</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb121-2"><a href="spatial-operations.html#cb121-2"></a><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></span></code></pre></div>
<p>Note that although the first point is <em>within</em> the triangle, it does not <em>touch</em> any part of its border.
For this reason <code>st_touches()</code> only returns <code>TRUE</code> for the second point:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="spatial-operations.html#cb122-1"></a><span class="kw">st_touches</span>(p, a, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb122-2"><a href="spatial-operations.html#cb122-2"></a><span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE</span></span></code></pre></div>
<p>What about features that do not touch, but <em>almost touch</em> the selection object?
These can be selected using <code>st_is_within_distance()</code>, which has an additional <code>dist</code> argument.
It can be used to set how close target objects need to be before they are selected.
Note that although point 4 is one unit of distance from the nearest node of <code>a</code> (at point 2 in Figure <a href="spatial-operations.html#fig:relation-objects">4.2</a>), it is still selected when the distance is set to 0.9.
This is illustrated in the code chunk below, the second line of which converts the lengthy list output into a <code>logical</code> object:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="spatial-operations.html#cb123-1"></a>sel =<span class="st"> </span><span class="kw">st_is_within_distance</span>(p, a, <span class="dt">dist =</span> <span class="fl">0.9</span>) <span class="co"># can only return a sparse matrix</span></span>
<span id="cb123-2"><a href="spatial-operations.html#cb123-2"></a><span class="kw">lengths</span>(sel) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb123-3"><a href="spatial-operations.html#cb123-3"></a><span class="co">#&gt; [1]  TRUE  TRUE FALSE  TRUE</span></span></code></pre></div>

<div class="rmdnote">
Functions for calculating topological relations use spatial indices to largely speed up spatial query performance.
They achieve that using the Sort-Tile-Recursive (STR) algorithm.
The <code>st_join</code> function, mentioned in the next section, also uses the spatial indexing.
You can learn more at <a href="https://www.r-spatial.org/r/2017/06/22/spatial-index.html" class="uri">https://www.r-spatial.org/r/2017/06/22/spatial-index.html</a>.
</div>

<!-- Equals: -->
<!-- https://postgis.net/docs/ST_Equals.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_equals(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Contains: -->
<!-- https://postgis.net/docs/ST_Contains.html -->
<!-- https://postgis.net/docs/ST_ContainsProperly.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_contains(a, b, sparse = FALSE) -->
<!-- st_contains_properly(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Covers: -->
<!-- https://postgis.net/docs/ST_Covers.html -->
<!-- https://postgis.net/docs/ST_CoveredBy.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_covers(a, b, sparse = FALSE) -->
<!-- st_covered_by(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Within: -->
<!-- https://postgis.net/docs/ST_Within.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_within(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Overlaps: -->
<!-- https://postgis.net/docs/ST_Overlaps.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_overlaps(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Intersects: -->
<!-- https://postgis.net/docs/ST_Intersects.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_intersects(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Disjoint: -->
<!-- https://postgis.net/docs/ST_Disjoint.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_disjoint(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Touches: -->
<!-- https://postgis.net/docs/ST_Touches.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_touches(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- Crosses: -->
<!-- https://postgis.net/docs/ST_Crosses.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_crosses(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- DE9-IM - https://en.wikipedia.org/wiki/DE-9IM -->
<!-- https://edzer.github.io/sfr/reference/st_relate.html -->
<!-- ```{r, eval=FALSE} -->
<!-- st_relate(a, b, sparse = FALSE) -->
<!-- ``` -->
<!-- examples (points/polygons) -->
<!-- examples (points/lines) -->
<!-- examples (lines/polygons) -->
<!-- TODO? create a series of polygons distributed evenly over the surface of the Earth and clip them. -->
<!-- set.seed(2018) -->
<!-- blob_points = st_sample(x = world, size = 2) -->
<!-- blobs = st_buffer(x = blob_points, dist = 1) -->
<!-- plot(blobs) -->
</div>
<div id="spatial-joining" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Spatial joining</h3>
<p>Joining two non-spatial datasets relies on a shared ‘key’ variable, as described in Section <a href="attr.html#vector-attribute-joining">3.2.3</a>.
Spatial data joining applies the same concept, but instead relies on shared areas of geographic space (it is also known as spatial overlay).
As with attribute data, joining adds a new column to the target object (the argument <code>x</code> in joining functions), from a source object (<code>y</code>).

</p>
<p>The process can be illustrated by an example.
Imagine you have ten points randomly distributed across the Earth’s surface.
Of the points that are on land, which countries are they in?
Random points to demonstrate spatial joining are created as follows:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="spatial-operations.html#cb124-1"></a><span class="kw">set.seed</span>(<span class="dv">2018</span>) <span class="co"># set seed for reproducibility</span></span>
<span id="cb124-2"><a href="spatial-operations.html#cb124-2"></a>(<span class="dt">bb_world =</span> <span class="kw">st_bbox</span>(world)) <span class="co"># the world&#39;s bounds</span></span>
<span id="cb124-3"><a href="spatial-operations.html#cb124-3"></a><span class="co">#&gt;   xmin   ymin   xmax   ymax </span></span>
<span id="cb124-4"><a href="spatial-operations.html#cb124-4"></a><span class="co">#&gt; -180.0  -89.9  180.0   83.6</span></span>
<span id="cb124-5"><a href="spatial-operations.html#cb124-5"></a>random_df =<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb124-6"><a href="spatial-operations.html#cb124-6"></a>  <span class="dt">x =</span> <span class="kw">runif</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">min =</span> bb_world[<span class="dv">1</span>], <span class="dt">max =</span> bb_world[<span class="dv">3</span>]),</span>
<span id="cb124-7"><a href="spatial-operations.html#cb124-7"></a>  <span class="dt">y =</span> <span class="kw">runif</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">min =</span> bb_world[<span class="dv">2</span>], <span class="dt">max =</span> bb_world[<span class="dv">4</span>])</span>
<span id="cb124-8"><a href="spatial-operations.html#cb124-8"></a>)</span>
<span id="cb124-9"><a href="spatial-operations.html#cb124-9"></a>random_points =<span class="st"> </span>random_df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb124-10"><a href="spatial-operations.html#cb124-10"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># set coordinates</span></span>
<span id="cb124-11"><a href="spatial-operations.html#cb124-11"></a><span class="st">  </span><span class="kw">st_set_crs</span>(<span class="dv">4326</span>) <span class="co"># set geographic CRS</span></span></code></pre></div>
<!-- This may seem a trivial question but if you consider being placed somewhere at random it would surely take some time to discover where you were and you'd probably have to ask someone. **comment - removed as it's too long-winded (RL)** -->
<p>The scenario is illustrated in Figure <a href="spatial-operations.html#fig:spatial-join">4.3</a>.
The <code>random_points</code> object (top left) has no attribute data, while the <code>world</code> (top right) does.
The spatial join operation is done by <code>st_join()</code>, which adds the <code>name_long</code> variable to the points, resulting in <code>random_joined</code> which is illustrated in Figure <a href="spatial-operations.html#fig:spatial-join">4.3</a> (bottom left — see <a href="https://github.com/Robinlovelace/geocompr/blob/master/code/04-spatial-join.R"><code>04-spatial-join.R</code></a>).
Before creating the joined dataset, we use spatial subsetting to create <code>world_random</code>, which contains only countries that contain random points, to verify the number of country names returned in the joined dataset should be four (see the top right panel of Figure <a href="spatial-operations.html#fig:spatial-join">4.3</a>).</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="spatial-operations.html#cb125-1"></a>world_random =<span class="st"> </span>world[random_points, ]</span>
<span id="cb125-2"><a href="spatial-operations.html#cb125-2"></a><span class="kw">nrow</span>(world_random)</span>
<span id="cb125-3"><a href="spatial-operations.html#cb125-3"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb125-4"><a href="spatial-operations.html#cb125-4"></a>random_joined =<span class="st"> </span><span class="kw">st_join</span>(random_points, world[<span class="st">&quot;name_long&quot;</span>])</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:spatial-join"></span>
<img src="04-spatial-operations_files/figure-html/spatial-join-1.png" alt="Illustration of a spatial join. A new attribute variable is added to random points (top left) from source world object (top right) resulting in the data represented in the final panel." width="100%" />
<p class="caption">
FIGURE 4.3: Illustration of a spatial join. A new attribute variable is added to random points (top left) from source world object (top right) resulting in the data represented in the final panel.
</p>
</div>
<p>By default, <code>st_join()</code> performs a left join (see Section <a href="attr.html#vector-attribute-joining">3.2.3</a>), but it can also do inner joins by setting the argument <code>left = FALSE</code>.
Like spatial subsetting, the default topological operator used by <code>st_join()</code> is <code>st_intersects()</code>.
This can be changed with the <code>join</code> argument (see <code>?st_join</code> for details).
In the example above, we have added features of a polygon layer to a point layer.
In other cases, we might want to join point attributes to a polygon layer.
There might be occasions where more than one point falls inside one polygon.
In such a case <code>st_join()</code> duplicates the polygon feature: it creates a new row for each match.</p>
</div>
<div id="non-overlapping-joins" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Non-overlapping joins</h3>
<p>Sometimes two geographic datasets do not touch but still have a strong geographic relationship enabling joins.
The datasets <code>cycle_hire</code> and <code>cycle_hire_osm</code>, already attached in the <strong>spData</strong> package, provide a good example.
Plotting them shows that they are often closely related but they do not touch, as shown in Figure <a href="spatial-operations.html#fig:cycle-hire">4.4</a>, a base version of which is created with the following code below:
</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="spatial-operations.html#cb126-1"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(cycle_hire), <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb126-2"><a href="spatial-operations.html#cb126-2"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(cycle_hire_osm), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p>We can check if any points are the same <code>st_intersects()</code> as shown below:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="spatial-operations.html#cb127-1"></a><span class="kw">any</span>(<span class="kw">st_touches</span>(cycle_hire, cycle_hire_osm, <span class="dt">sparse =</span> <span class="ot">FALSE</span>))</span>
<span id="cb127-2"><a href="spatial-operations.html#cb127-2"></a><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cycle-hire"></span>
<div id="htmlwidget-9580c84d0c32f0a22a8c" style="width:100%;height:415.296px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-9580c84d0c32f0a22a8c">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addCircles","args":[[51.52916347,51.49960695,51.52128377,51.53005939,51.49313,51.51811784,51.53430039,51.52834133,51.5073853,51.50597426,51.52395143,51.52168078,51.51991453,51.52994371,51.51772703,51.52635795,51.5216612,51.51477076,51.52505093,51.52773634,51.53007835,51.5222641,51.51943538,51.51908011,51.5288338,51.52728093,51.51382102,51.52351808,51.513735,51.52915444,51.52953709,51.52469624,51.5341235,51.50173726,51.49159394,51.4973875,51.5263778,51.52127071,51.52001715,51.53099181,51.52026,51.51073687,51.522511,51.507131,51.52334476,51.51248445,51.50706909,51.52867339,51.52671796,51.52295439,51.5099923,51.52174785,51.51707521,51.52058381,51.52334672,51.52452699,51.53176825,51.52644828,51.49738251,51.4907579,51.53089041,51.50946212,51.52522753,51.51795029,51.51882555,51.52059681,51.5262363,51.53136059,51.5154186,51.52352001,51.52572618,51.48591714,51.53219984,51.52559505,51.52341837,51.52486887,51.50069361,51.52025302,51.514274,51.50963938,51.51593725,51.50064702,51.48947903,51.51646835,51.51858757,51.5262503,51.53301907,51.49368637,51.49889832,51.53440868,51.49506109,51.5208417,51.53095071,51.49792478,51.52554222,51.51457763,51.49043573,51.51155322,51.51340693,51.50472376,51.51159481,51.51552971,51.51410514,51.52600832,51.49812559,51.51563144,51.53304322,51.5100172,51.51580998,51.49646288,51.52451738,51.51423368,51.51449962,51.49288067,51.49582705,51.52589324,51.51573534,51.51891348,51.52111369,51.52836014,51.49654462,51.50069491,51.51782144,51.51700801,51.49536226,51.5118973,51.50950627,51.53300545,51.52364804,51.50136494,51.504904,51.52326004,51.51196176,51.49087475,51.51227622,51.49488108,51.52096262,51.51530805,51.49372451,51.4968865,51.48894022,51.50074359,51.48836528,51.51494305,51.49211134,51.48478899,51.49705603,51.51213691,51.49217002,51.51183419,51.50379168,51.49586666,51.49443626,51.50039792,51.49085368,51.51461995,51.50663341,51.49234577,51.51760685,51.4931848,51.515607,51.517932,51.50185512,51.49395092,51.50040123,51.51474612,51.52784273,51.4916156,51.49121192,51.50486,51.512529,51.52174384,51.51791921,51.49616092,51.48985626,51.5129118,51.49941247,51.52202903,51.52071513,51.48805753,51.51733558,51.49247977,51.5165179,51.53166681,51.48997562,51.50311799,51.51251523,51.50581776,51.50462759,51.50724437,51.50368837,51.50556905,51.51048489,51.51492456,51.5225965,51.51236389,51.51821864,51.52659961,51.518144,51.518154,51.50135267,51.52505151,51.49358391,51.51681444,51.49464523,51.50658458,51.50274025,51.52683806,51.51906932,51.49094565,51.51615461,51.48971651,51.49016361,51.49066456,51.49481649,51.50275704,51.49148474,51.51476963,51.50935342,51.50844614,51.52891573,51.50742485,51.50654321,51.50669284,51.49396755,51.51501025,51.50777049,51.53450449,51.49571828,51.51838043,51.5084448,51.5233534,51.52443845,51.50545935,51.52200801,51.49096258,51.51611887,51.4853572,51.52285301,51.530052,51.50645179,51.49859784,51.489932,51.518908,51.5046364,51.53404294,51.53051587,51.52557531,51.51362054,51.52248185,51.50143293,51.50494561,51.5136846,51.5134891,51.49874469,51.51422502,51.52644342,51.51595344,51.50102668,51.49206037,51.49320445,51.50082346,51.4863434,51.53583617,51.50144456,51.50613324,51.49671237,51.52004497,51.50930161,51.50315739,51.5034938,51.51862243,51.490083,51.49580589,51.51906446,51.49914063,51.5272947,51.52367314,51.49236962,51.50923022,51.51678023,51.48483991,51.49888404,51.49815779,51.488226,51.50029631,51.49363156,51.49612799,51.50227992,51.49398524,51.50501351,51.51475963,51.466907,51.50295379,51.51211869,51.48677988,51.51816295,51.50990837,51.49907558,51.50963123,51.4908679,51.51918144,51.53088935,51.51734403,51.50088934,51.52536703,51.49768448,51.49679128,51.51004801,51.52702563,51.49357351,51.49785559,51.526293,51.523196,51.49652013,51.50908747,51.53266186,51.53114,51.53095,51.53589283,51.51641749,51.52085887,51.49334336,51.50860544,51.505044,51.51196803,51.504942,51.51108452,51.51175646,51.5333196,51.51444134,51.50810309,51.53692216,51.528246,51.48802358,51.50013942,51.51217033,51.51196,51.5017154373867,51.529423,51.486965,51.49459148,51.506767,51.486575,51.494412,51.520994,51.51643491,51.49782999,51.49675303,51.50391972,51.536264,51.5291212008901,51.519656,51.530344,51.5109192966489,51.5173721,51.50024195,51.520205,51.49775,51.515208,51.49980661,51.50402793,51.50194596,51.49188409,51.50535447,51.49559291,51.51431171,51.50686435,51.51953043,51.50935171,51.51310333,51.496481,51.51352755,51.49369988,51.51070161,51.51013066,51.521776,51.51066202,51.49942855,51.51733427,51.524826,51.492462,51.51809,51.51348,51.502319,51.52261762,51.517703,51.528187,51.52289229,51.51689296,51.50204238,51.49418566,51.512303,51.51222,51.51994326,51.493146,51.519968,51.49337264,51.488105,51.485821,51.504043,51.504044,51.49456127,51.490491,51.533379,51.493072,51.51397065,51.499917,51.48902,51.534474,51.496957,51.524564,51.488852,51.51824,51.488124,51.5338,51.483145,51.495656,51.510101,51.515256,51.52568,51.52388,51.528936,51.493381,51.50623,51.511088,51.515975,51.504719,51.505697,51.508447,51.487679,51.49447,51.538071,51.542138,51.504749,51.535179,51.516196,51.516,51.541603,51.534776,51.51417,51.53558,51.534464,51.523538,51.521564,51.513757,51.530535,51.533283,51.529452,51.496137,51.498125,51.499041,51.489096,51.49109,51.521889,51.527152,51.5128711,51.487129,51.509843,51.51328,51.528828,51.531127,51.525645,51.511811,51.506946,51.513074,51.508622,51.522507,51.524677,51.50196,51.528169,51.52512,51.527058,51.519265,51.522561,51.502635,51.520893,51.496454,51.520398,51.517475,51.528692,51.519362,51.517842,51.509303,51.511066,51.532091,51.5142228,51.516204,51.500088,51.5112,51.532513,51.528224,51.518811,51.526041,51.534137,51.525941,51.51549,51.511654,51.504714,51.503143,51.503802,51.507326,51.486892,51.508896,51.530326,51.50357,51.528222,51.531864,51.537349,51.51793,51.508981,51.531091,51.528302,51.506613,51.514115,51.509591,51.526153,51.539957,51.517428,51.509474,51.498386,51.49605,51.521564,51.503447,51.511542,51.535678,51.513548,51.502661,51.51601,51.493978,51.501391,51.511624,51.518369,51.51746,51.499286,51.509943,51.521905,51.509158,51.51616,51.53213,51.503083,51.506256,51.539099,51.485587,51.53356,51.497304,51.528869,51.527607,51.511246,51.48692917,51.497622,51.51244,51.490645,51.50964,51.52959,51.487196,51.53256,51.506093,51.5171,51.531066,51.513875,51.493267,51.472817,51.473471,51.494499,51.485743,51.481747,51.514767,51.472993,51.477839,51.538792,51.520331,51.504199,51.468814,51.491093,51.46512358,51.48256792,51.50646524,51.46925984,51.50403821,51.47817208,51.4768851,51.48102131,51.47107905,51.47625965,51.4737636,51.47518024,51.46086446,51.50748124,51.46193072,51.4729184,51.47761941,51.48438657,51.4687905,51.46881971,51.45995384,51.47073264,51.4795017,51.47053858,51.48959104,51.49434708,51.48606206,51.46706414,51.45787019,51.46663393,51.48357068,51.47286577,51.49824168,51.46916161,51.5190427,51.48373225,51.50173215,51.49886563,51.50035306,51.46904022,51.48180515,51.51687069,51.48089844,51.51148696,51.47084722,51.48267821,51.48294452,51.46841875,51.4996806,51.47729232,51.46437067,51.49087074,51.51632095,51.48498496,51.51323001,51.474376,51.46108367,51.49610093,51.5015946,51.49422354,51.47614939,51.46718562,51.475089,51.4646884,51.46517078,51.53546778,51.46348914,51.47787084,51.46866929,51.46231278,51.47453545,51.47768469,51.47303687,51.48810829,51.46506424,51.45475251,51.46067005,51.48814438,51.49760804,51.46095151,51.45922541,51.47047503,51.47946386,51.54211855,51.464786,51.53638435,51.48728535,51.53639219,51.53908372,51.5366541,51.47696496,51.47287627,51.52868155,51.51505991,51.45682071,51.45971528,51.50215353,51.49021762,51.46161068,51.46321128,51.47439218,51.48335692,51.51854104,51.54100708,51.47311696,51.51563007,51.51542791,51.53658514,51.53571683,51.53642464,51.48724429,51.53603947,51.52458353,51.46822047,51.45799126,51.47732253,51.47505096,51.47569809,51.46199911,51.47893931,51.49208492,51.47727637,51.50630441,51.50542628,51.46230566,51.46489445,51.47993289,51.47514228,51.48176572,51.51092871,51.5129814,51.51510818,51.46079243,51.46745485,51.47816972,51.4795738,51.48796408,51.53727795,51.53932857,51.4710956,51.51612862,51.45816465,51.49263658,51.5129006,51.48512191,51.47515398,51.48795853,51.51787005,51.52456169,51.52526975,51.48321729,51.50070305,51.52059714,51.46239255,51.46760141,51.45752945,51.45705988,51.46134382,51.473611,51.491026,51.509224,51.47250956,51.511891,51.470131,51.496664,51.460333,51.4619230679],[-0.109970527,-0.197574246,-0.084605692,-0.120973687,-0.156876,-0.144228881,-0.1680743,-0.170134484,-0.096440751,-0.092754157,-0.122502346,-0.130431727,-0.136039674,-0.123616824,-0.127854211,-0.125979294,-0.109006325,-0.12221963,-0.131161087,-0.135273468,-0.13884627,-0.114079481,-0.119123345,-0.124678402,-0.132250369,-0.11829517,-0.107927706,-0.143613641,-0.193487,-0.093421615,-0.083353323,-0.084439283,-0.129386874,-0.184980612,-0.192369256,-0.197245586,-0.078130921,-0.0755789,-0.083911168,-0.093903825,-0.157183945,-0.144165239,-0.162298,-0.06691,-0.183846408,-0.099141408,-0.145904427,-0.087459376,-0.104298194,-0.094934859,-0.143495266,-0.094475072,-0.086685542,-0.154701411,-0.120202614,-0.079248081,-0.114329032,-0.172190727,-0.089446947,-0.106323685,-0.089782579,-0.124749274,-0.13518856,-0.108657431,-0.108028472,-0.116688468,-0.134407652,-0.117069978,-0.098850915,-0.108340165,-0.088486188,-0.124469948,-0.105480698,-0.144083893,-0.124121774,-0.099489485,-0.102091246,-0.141327271,-0.111257,-0.131510949,-0.111778348,-0.078600401,-0.115156562,-0.079684557,-0.132053392,-0.123509611,-0.139174593,-0.111014912,-0.100440521,-0.109025404,-0.085814489,-0.097340162,-0.078505384,-0.183834706,-0.138231303,-0.158264483,-0.122806861,-0.0929401,-0.076793375,-0.192538767,-0.077121322,-0.190240716,-0.147301667,-0.096317627,-0.132102166,-0.132328837,-0.172528678,-0.157275636,-0.105270275,-0.183289032,-0.158963647,-0.073537654,-0.141423695,-0.114934001,-0.13547809,-0.090847761,-0.093080779,-0.156166631,-0.078869751,-0.104724625,-0.150905245,-0.094524319,-0.096496865,-0.09388536,-0.185296516,-0.137043852,-0.075459482,-0.136792671,-0.074754872,-0.191462381,-0.06797,-0.104708922,-0.097441687,-0.153319609,-0.157436972,-0.117974901,-0.085634242,-0.147203711,-0.198286569,-0.161203828,-0.111435796,-0.202759212,-0.129361842,-0.11614642,-0.138364847,-0.110683213,-0.168917077,-0.201554966,-0.101536865,-0.174292825,-0.11282408,-0.191933711,-0.092921165,-0.193068385,-0.196170309,-0.137841333,-0.131773845,-0.141334487,-0.121328408,-0.167894973,-0.183118788,-0.183716959,-0.159237081,-0.147624377,-0.195455928,-0.165164288,-0.108068155,-0.186753859,-0.173715911,-0.113001,-0.115163,-0.0811189,-0.188098863,-0.140947636,-0.141923621,-0.153645496,-0.152317537,-0.165842551,-0.14521173,-0.140741432,-0.175810943,-0.178433004,-0.164393768,-0.109914711,-0.132845681,-0.153520935,-0.133201961,-0.100186337,-0.091773776,-0.106237501,-0.098497684,-0.111606696,-0.082989638,-0.066078037,-0.161113413,-0.06954201,-0.100791005,-0.112432615,-0.06275,-0.062697,-0.153194766,-0.166304359,-0.165101392,-0.151926305,-0.158105512,-0.199004026,-0.149569201,-0.130504336,-0.088285377,-0.181190899,-0.082422399,-0.170194408,-0.19039362,-0.166485083,-0.13045856,-0.155349725,-0.090220911,-0.188129731,-0.196422,-0.131961389,-0.115480888,-0.134621209,-0.123179697,-0.103137426,-0.17873226,-0.112753217,-0.130699733,-0.106992706,-0.110889274,-0.073438925,-0.067176443,-0.175116099,-0.138019439,-0.10569204,-0.151359288,-0.139625122,-0.128585022,-0.142207481,-0.099994052,-0.168314,-0.170279555,-0.096191134,-0.162727,-0.079249,-0.116542278,-0.086379717,-0.106408455,-0.179592915,-0.116764211,-0.154907218,-0.178656971,-0.123247648,-0.135580879,-0.191351186,-0.103132904,-0.080660083,-0.109256828,-0.169249375,-0.180246101,-0.132224622,-0.144132875,-0.089740764,-0.122492418,-0.156285395,-0.110699309,-0.114686385,-0.20528437,-0.092176447,-0.084985356,-0.191496313,-0.07962099,-0.176645823,-0.162418,-0.127575233,-0.059642081,-0.112031483,-0.174653609,-0.128377673,-0.147478734,-0.151296092,-0.175488803,-0.138089062,-0.165471605,-0.209494128,-0.135635511,-0.092762704,-0.190603326,-0.106000855,-0.074189225,-0.136928582,-0.172729559,-0.148105415,-0.216573,-0.158456089,-0.16209757,-0.115853961,-0.135025698,-0.187842717,-0.085666316,-0.119047563,-0.116911864,-0.140485596,-0.176770502,-0.138072691,-0.083159352,-0.153463612,-0.141943703,-0.093913472,-0.138846453,-0.088542771,-0.139956043,-0.081608045,-0.073955,-0.083067,-0.101384068,-0.129697889,-0.099981142,-0.086016,-0.085603,-0.160854428,-0.179135079,-0.089887855,-0.194757949,-0.193764092,-0.115851,-0.120718759,-0.115533,-0.197524944,-0.119643424,-0.111781191,-0.087587447,-0.12602103,-0.150181444,-0.10102611,-0.166878535,-0.113936001,-0.150481272,-0.142783033,-0.1798541843891,-0.097122,-0.116625,-0.134234258,-0.123702,-0.117286,-0.173881,-0.139016,-0.124332175,-0.135440826,-0.138733562,-0.11342628,-0.133952,-0.171185284853,-0.132339,-0.100168,-0.1511263847351,-0.1642075,-0.15934065,-0.174593,-0.10988,-0.117863,-0.176415994,-0.11386435,-0.194392952,-0.125674815,-0.113656543,-0.179077626,-0.200838199,-0.150666888,-0.13577731,-0.14744969,-0.13121385,-0.192404,-0.130110822,-0.121394101,-0.121723604,-0.155757901,-0.068856,-0.142345694,-0.179702476,-0.103604248,-0.176268,-0.159919,-0.163609,-0.17977,-0.200742,-0.071653961,-0.154106,-0.075375,-0.171681991,-0.158249929,-0.184400221,-0.18267094,-0.159988,-0.160785,-0.170704337,-0.099828,-0.169774,-0.09968067,-0.110121,-0.149004,-0.105312,-0.104778,-0.15393398,-0.149186,-0.139159,-0.129925,-0.09294031,-0.174554,-0.17524,-0.122203,-0.173894,-0.116279,-0.105593,-0.11655,-0.120903,-0.118677,-0.113134,-0.114605,-0.211358,-0.058641,-0.055312,-0.065076,-0.055894,-0.007542,-0.02296,-0.057159,-0.053177,-0.063531,-0.070542,-0.055167,-0.021582,-0.014409,-0.144664,-0.145393,-0.057544,-0.03338,-0.029138,-0.038775,-0.138853,-0.071881,-0.052099,-0.08249,-0.076341,-0.030556,-0.022694,-0.020467,-0.025492,-0.028155,-0.027616,-0.019355,-0.011457,-0.020157,-0.009205,-0.018716,-0.04667,-0.058005,-0.0389866,-0.009001,-0.02377,-0.047784,-0.013258,-0.048017,-0.069543,-0.025626,-0.058681,-0.064094,-0.065006,-0.041378,-0.03562,-0.016251,-0.018703,-0.015578,-0.025296,-0.021345,-0.054883,-0.022702,-0.051394,-0.009506,-0.026768,-0.075855,-0.059091,-0.074431,-0.090075,-0.025996,-0.053558,-0.06142,-0.055656,-0.155525,-0.211316,-0.014438,-0.033085,-0.037471,-0.011662,-0.047218,-0.037366,-0.036017,-0.013475,-0.179668,-0.014293,-0.008428,-0.215808,-0.145827,-0.170983,-0.012413,-0.042744,-0.020068,-0.069743,-0.066035,-0.147154,-0.067937,-0.00699,-0.075901,-0.144466,-0.142844,-0.033828,-0.204666,-0.102208,-0.145246,-0.107987,-0.002275,-0.107913,-0.104193,-0.039264,-0.016233,-0.056667,-0.062546,-0.005659,-0.021596,-0.0985,-0.127554,-0.205991,-0.205921,-0.043371,-0.12335,-0.009152,-0.117619,-0.063386,-0.224103,-0.18697,-0.08299,-0.017676,-0.218337,-0.141728,-0.18119,-0.09315,-0.022793,-0.047548,-0.057133,-0.093051,-0.102996299,-0.125978,-0.19096,-0.014582,-0.08497,-0.0801,-0.179369,-0.16862,-0.2242237,-0.18377,-0.11934,-0.117774,-0.21985,-0.199783,-0.20782,-0.228188,-0.223616,-0.124642,-0.225787,-0.133972,-0.116493,-0.138535,-0.163667,-0.210941,-0.210279,-0.216493,-0.157788279,-0.172078187,-0.208486599,-0.141812513,-0.217400093,-0.144690541,-0.215895601,-0.209973497,-0.207842908,-0.193254007,-0.197010096,-0.167160736,-0.187427294,-0.205535908,-0.180791784,-0.132102704,-0.149551631,-0.20481514,-0.158230901,-0.184318843,-0.190184054,-0.126994068,-0.141770709,-0.163041605,-0.209378594,-0.215804559,-0.214428378,-0.193502076,-0.174691623,-0.169821175,-0.202038682,-0.148059277,-0.117495865,-0.174485792,-0.204764421,-0.223852256,-0.100292412,-0.137424571,-0.217515071,-0.19627483,-0.18027465,-0.213872396,-0.183853573,-0.218190203,-0.17070367,-0.117661574,-0.219346128,-0.199135704,-0.221791552,-0.16478637,-0.174619404,-0.206029743,-0.202608612,-0.167919869,-0.211593602,-0.155442787,-0.191722864,-0.208158259,-0.222293381,-0.236769936,-0.1232585,-0.152248582,-0.201968,-0.173656546,-0.18038939,-0.11619105,-0.182126248,-0.126874471,-0.146544642,-0.211468596,-0.170210533,-0.170329317,-0.214749808,-0.22660621,-0.163750945,-0.195197203,-0.198735357,-0.222456468,-0.21145598,-0.20066766,-0.180884959,-0.152130083,-0.195777222,-0.028941601,-0.215618902,-0.102757578,-0.217995921,-0.112721065,-0.070329419,-0.07023031,-0.174347066,-0.176267008,-0.065550321,-0.10534448,-0.202802098,-0.212145939,-0.083632928,-0.215087092,-0.21614583,-0.215550761,-0.163347594,-0.216305546,-0.034903714,-0.14326094,-0.137235175,-0.049067243,-0.02356501,-0.075885686,-0.060291813,-0.054162264,-0.205279052,-0.026262677,-0.058631453,-0.190346493,-0.184806157,-0.138748723,-0.150908371,-0.20587627,-0.206240805,-0.208485293,-0.229116862,-0.189210466,-0.087262995,-0.150817316,-0.175407201,-0.17302926,-0.19411695,-0.187278987,-0.185273723,-0.214594781,-0.219486603,-0.208565479,-0.212607684,-0.172293499,-0.18243547,-0.17903854,-0.161765173,-0.079201849,-0.074284675,-0.157850096,-0.120909408,-0.20600248,-0.234094148,-0.214762686,-0.174971902,-0.159169801,-0.187404506,-0.201005397,-0.165668686,-0.163795009,-0.211860644,-0.129698963,-0.032566533,-0.16829214,-0.20682737,-0.192165613,-0.200806304,-0.159322467,-0.191803,-0.209121,-0.216016,-0.122831913,-0.107349,-0.20464,-0.223868,-0.167029,-0.165297856693],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]},{"method":"addCircles","args":[[51.529125213623,51.5340156555176,51.5272903442383,51.5258293151855,51.5300140380859,51.5259437561035,51.5266494750977,51.5208587646484,51.5168228149414,51.5147361755371,51.4941635131836,51.500617980957,51.5178031921387,51.513298034668,51.5140533447266,51.5122489929199,51.4882698059082,51.5008125305176,51.5244827270508,51.500560760498,51.5033798217773,51.4950714111328,51.5074768066406,51.51416015625,51.5164070129395,51.5160675048828,51.5017127990723,51.502010345459,51.4952964782715,51.5189933776855,51.5199699401855,51.5119400024414,51.5217094421387,51.5156631469727,51.5124855041504,51.497802734375,51.5099983215332,51.4907989501953,51.4915580749512,51.5123100280762,51.4915046691895,51.5176963806152,51.5121421813965,51.4901008605957,51.5147857666016,51.4935836791992,51.4990310668945,51.4914512634277,51.5021781921387,51.5250129699707,51.5224571228027,51.522876739502,51.5253219604492,51.5219688415527,51.5164794921875,51.5145263671875,51.5168113708496,51.5358810424805,51.5181121826172,51.5233421325684,51.5256538391113,51.516731262207,51.5283546447754,51.5225028991699,51.530876159668,51.517276763916,51.5119209289551,51.5343589782715,51.5153121948242,51.5273170471191,51.5264739990234,51.5205345153809,51.5330848693848,51.5226020812988,51.5369148254395,51.5146942138672,51.5255584716797,51.5202369689941,51.5140647888184,51.5234184265137,51.5207405090332,51.5251617431641,51.5185699462891,51.5233764648438,51.5014801025391,51.5247001647949,51.4908981323242,51.5139122009277,51.5179023742676,51.5232048034668,51.5187034606934,51.5149116516113,51.5232696533203,51.5239067077637,51.5309143066406,51.5326194763184,51.5245056152344,51.5096054077148,51.5159797668457,51.5060081481934,51.5009002685547,51.5094451904297,51.5194892883301,51.5182151794434,51.5308990478516,51.521785736084,51.5235176086426,51.5269660949707,51.5086212158203,51.5047836303711,51.5065536499023,51.5093650817871,51.5111045837402,51.5031242370605,51.5027618408203,51.5063591003418,51.5027046203613,51.5030288696289,51.5228729248047,51.5071983337402,51.5067367553711,51.5333480834961,51.5329170227051,51.5173492431641,51.5254859924316,51.5202293395996,51.5236930847168,51.5276756286621,51.5300102233887,51.5288047790527,51.5262718200684,51.5092506408691,51.5185928344727,51.533073425293,51.5191764831543,51.5267524719238,51.5128898620605,51.5122489929199,51.5107154846191,51.5118522644043,51.509937286377,51.5099258422852,51.5119094848633,51.5057373046875,51.5053520202637,51.5158920288086,51.5115776062012,51.5170211791992,51.5191650390625,51.5209693908691,51.5216751098633,51.5319747924805,51.4943504333496,51.5294418334961,51.514461517334,51.5161094665527,51.5190467834473,51.5243988037109,51.5250663757324,51.5257682800293,51.5267105102539,51.5210418701172,51.4991226196289,51.4948768615723,51.4920654296875,51.4959564208984,51.4921226501465,51.5308647155762,51.5092468261719,51.5234756469727,51.5154342651367,51.5006256103516,51.4989547729492,51.5036697387695,51.4911231994629,51.5205955505371,51.4908218383789,51.4955253601074,51.5011711120605,51.4939422607422,51.5135307312012,51.4967422485352,51.4979972839355,51.5018653869629,51.4939193725586,51.4941368103027,51.4923629760742,51.507080078125,51.4970092773438,51.4936447143555,51.4965591430664,51.4994621276855,51.4988174438477,51.5012893676758,51.4946479797363,51.4931907653809,51.4924049377441,51.4978790283203,51.4901084899902,51.4899024963379,51.4911193847656,51.4897422790527,51.4880409240723,51.4907531738281,51.5014457702637,51.5119781494141,51.5103721618652,51.4921836853027,51.5150375366211,51.5065040588379,51.5149192810059,51.5050163269043,51.5117492675781,51.5143547058105,51.506591796875,51.5076751708984,51.5074043273926,51.5080032348633,51.5084495544434,51.5090751647949,51.5096893310547,51.5175819396973,51.513744354248,51.514705657959,51.5144729614258,51.5313301086426,51.5283851623535,51.5264587402344,51.5267333984375,51.5304489135742,51.5282669067383,51.528881072998,51.5291633605957,51.5278205871582,51.5318183898926,51.5345153808594,51.5316009521484,51.5344848632812,51.5183601379395,51.5100250244141,51.5299301147461,51.5262222290039,51.5046043395996,51.4964332580566,51.5157890319824,51.5137596130371,51.5159225463867,51.5094718933105,51.4948692321777,51.4958152770996,51.493968963623,51.4961357116699,51.5263519287109,51.4882659912109,51.493221282959,51.4923477172852,51.4936294555664,51.4899444580078,51.5057983398438,51.4853782653809,51.488109588623,51.4898338317871,51.4981575012207,51.5164451599121,51.5305595397949,51.4848556518555,51.5179138183594,51.5148849487305,51.5155792236328,51.5179176330566,51.5156059265137,51.5171279907227,51.5189018249512,51.5142593383789,51.5121574401855,51.5222663879395,51.4986839294434,51.4996109008789,51.500316619873,51.4973487854004,51.4966926574707,51.5003280639648,51.4962997436523,51.5053176879883,51.5006370544434,51.4980773925781,51.5183410644531,51.4937019348145,51.4933166503906,51.4958381652832,51.501407623291,51.518970489502,51.5046882629395,51.5213012695312,51.4974403381348,51.4907531738281,51.4868087768555,51.4862594604492,51.4937286376953,51.489444732666,51.492862701416,51.4848365783691,51.4904365539551,51.4957122802734,51.4889488220215,51.4860305786133,51.4908561706543,51.5000915527344,51.51220703125,51.5017890930176,51.5172843933105,51.5029449462891,51.5115776062012,51.5177955627441,51.5166702270508,51.4986000061035,51.4967498779297,51.5164489746094,51.5197067260742,51.4979667663574,51.5019798278809,51.5204887390137,51.4968948364258,51.5194702148438,51.5209770202637,51.513484954834,51.5129928588867,51.5295066833496,51.5109214782715,51.5181312561035,51.5093536376953,51.5107040405273,51.5068664550781,51.4971313476562,51.4997673034668,51.5023498535156,51.5360565185547,51.5134391784668,51.5176811218262,51.5180625915527,51.5136108398438,51.5100975036621,51.5106239318848,51.4994277954102,51.4917526245117,51.517276763916,51.5125617980957,51.5200080871582,51.5002670288086,51.5226516723633,51.5199127197266,51.5202560424805,51.519889831543,51.5150718688965,51.5041122436523,51.5224304199219,51.5236129760742,51.5246696472168,51.5218658447266,51.5059242248535,51.4934043884277,51.493106842041,51.5321311950684,51.5357322692871,51.5163230895996,51.5344505310059,51.5337982177734,51.4944076538086,51.5264663696289,51.531551361084,51.5303039550781,51.5311050415039,51.510139465332,51.5091667175293,51.5091285705566,51.5117263793945,51.5173530578613,51.5073699951172,51.5064506530762,51.5013732910156,51.5063514709473,51.5334243774414,51.519157409668,51.5282096862793,51.5061111450195,51.5050506591797,51.5048637390137,51.5039672851562,51.5037879943848,51.517147064209,51.5160942077637,51.5123672485352,51.5235061645508,51.5163383483887,51.5112266540527,51.5116233825684,51.5140647888184,51.5175437927246,51.5209159851074,51.525691986084,51.5225563049316,51.5340919494629,51.5289916992188,51.53515625,51.5325050354004,51.533317565918,51.5305099487305,51.5294303894043,51.5288352966309,51.5260200500488,51.4999237060547,51.528678894043,51.5112457275391,51.5142059326172,51.5110816955566,51.5192031860352,51.5088996887207,51.5390510559082,51.5092964172363,51.4875411987305,51.5162467956543,51.5311241149902,51.5309371948242,51.5070762634277,51.4960556030273,51.5289154052734,51.5288238525391,51.5289154052734,51.5288505554199,51.5288276672363,51.5288581848145,51.5287475585938,51.5287551879883,51.4969177246094,51.5017356872559,51.4592666625977,51.4619598388672,51.462329864502,51.4643669128418,51.4646339416504,51.4649353027344,51.5150985717773,51.4933090209961,51.4910316467285,51.5420379638672,51.5342826843262,51.5342788696289,51.5340614318848,51.5340614318848,51.4881706237793,51.5129814147949,51.5363426208496,51.4988250732422,51.5045928955078,51.5261192321777,51.5133056640625,51.5135383605957,51.5095901489258,51.5136680603027,51.5251502990723,51.5159912109375,51.4698219299316,51.4697875976562,51.4699058532715,51.4699401855469,51.488899230957,51.5295372009277,51.513744354248,51.5281829833984,51.5055847167969,51.5053405761719,51.5048713684082,51.5038681030273,51.5182075500488,51.5151634216309,51.5256118774414,51.5275001525879,51.527172088623,51.4920692443848,51.4730491638184,51.5115203857422,51.5215797424316,51.5194625854492,51.5380401611328,51.4958915710449,51.5040321350098,51.5040473937988,51.5041313171387,51.522575378418,51.5047378540039,51.5047645568848,51.5048065185547,51.5048294067383,51.5281829833984,51.4751319885254,51.5346603393555,51.528205871582,51.5468254089355,51.5462989807129,51.500301361084,51.5359039306641,51.5275382995605,51.540283203125,51.5359802246094,51.5118980407715,51.4939308166504,51.4814796447754,51.5410346984863,51.5416946411133,51.4858245849609,51.4675712585449,51.5387687683105,51.5164527893066,51.5039749145508,51.4762268066406,51.4794158935547,51.4799423217773,51.483585357666,51.4839019775391,51.5093116760254,51.5093193054199,51.5093231201172,51.5093383789062,51.5093421936035,51.5098342895508,51.509838104248,51.5099716186523,51.5099754333496,51.5408706665039,51.543083190918,51.5384292602539,51.5224761962891,51.4823341369629,51.5178565979004,51.5178756713867,51.5178985595703,51.5180282592773,51.4926681518555,51.5094337463379,51.5089530944824],[-0.0933877974748611,-0.129309207201004,-0.118235200643539,-0.0908360034227371,-0.121057197451591,-0.103827200829983,-0.112325102090836,-0.089885301887989,-0.158216997981071,-0.122161999344826,-0.182531297206879,-0.094515897333622,-0.0963746979832649,-0.0767054036259651,-0.0735850036144257,-0.0694098994135857,-0.135628700256348,-0.0898251011967659,-0.158880099654198,-0.0785683989524841,-0.0795795023441315,-0.0859436988830566,-0.096405602991581,-0.0806185975670815,-0.0796248018741608,-0.0821207985281944,-0.184889003634453,-0.184379398822784,-0.18527090549469,-0.1247294023633,-0.135864093899727,-0.120736703276634,-0.130427300930023,-0.13221150636673,-0.133161500096321,-0.0816432014107704,-0.157212495803833,-0.196125403046608,-0.186663806438446,-0.159797996282578,-0.192472696304321,-0.128009602427483,-0.162088096141815,-0.190465196967125,-0.16520619392395,-0.190665796399117,-0.0855932980775833,-0.0901288986206055,-0.0742235034704208,-0.166210398077965,-0.154845103621483,-0.171658992767334,-0.153420701622963,-0.151339396834373,-0.164416894316673,-0.15824930369854,-0.151897504925728,-0.160705104470253,-0.144139796495438,-0.183850601315498,-0.143984407186508,-0.175549402832985,-0.170091196894646,-0.162271693348885,-0.176805004477501,-0.175872594118118,-0.174384206533432,-0.168152794241905,-0.147055804729462,-0.174666598439217,-0.172155693173409,-0.154764696955681,-0.172641694545746,-0.161039903759956,-0.150157704949379,-0.148090302944183,-0.179504796862602,-0.157090201973915,-0.147284805774689,-0.175151601433754,-0.145077005028725,-0.135173499584198,-0.176669493317604,-0.124170199036598,-0.110720098018646,-0.0849407985806465,-0.139493301510811,-0.0928172022104263,-0.10842839628458,-0.104731000959873,-0.108025997877121,-0.0661884024739265,-0.120411798357964,-0.122491598129272,-0.0938763990998268,-0.0999554991722107,-0.0792410969734192,-0.0746577978134155,-0.16925460100174,-0.0927129983901978,-0.0834731012582779,-0.124383203685284,-0.119153201580048,-0.0626906976103783,-0.0785432010889053,-0.109234899282455,-0.108374498784542,-0.0886150002479553,-0.193726301193237,-0.192558497190475,-0.198990702629089,-0.196362406015396,-0.197485104203224,-0.153525605797768,-0.149403899908066,-0.170132204890251,-0.155268996953964,-0.191404402256012,-0.0999595001339912,-0.106189802289009,-0.103289797902107,-0.111789003014565,-0.136768698692322,-0.138106092810631,-0.138213202357292,-0.14128689467907,-0.128438904881477,-0.135379806160927,-0.138743206858635,-0.13221900165081,-0.134236499667168,-0.151116207242012,-0.131968900561333,-0.139157295227051,-0.140554800629616,-0.130548700690269,-0.153644695878029,-0.157555893063545,-0.1441929936409,-0.142809197306633,-0.138810202479362,-0.187907293438911,-0.137033000588417,-0.0997940972447395,-0.105653703212738,-0.0930432975292206,-0.0929120033979416,-0.0938486009836197,-0.0882396027445793,-0.0856646969914436,-0.094421498477459,-0.105481497943401,-0.0929258018732071,-0.0833719000220299,-0.0876550003886223,-0.128589496016502,-0.0597107000648975,-0.13815450668335,-0.131151705980301,-0.0884820967912674,-0.0781090036034584,-0.0787594988942146,-0.112052097916603,-0.11793690174818,-0.132180005311966,-0.135328501462936,-0.138317495584488,-0.0899377018213272,-0.0847280994057655,-0.143566697835922,-0.0988024994730949,-0.101928897202015,-0.100190803408623,-0.0984831005334854,-0.0971252992749214,-0.116697296500206,-0.181300804018974,-0.179187700152397,-0.180236399173737,-0.178733006119728,-0.191322594881058,-0.138812601566315,-0.143824398517609,-0.15922899544239,-0.14760759472847,-0.154608502984047,-0.147624105215073,-0.145930394530296,-0.168843403458595,-0.164939492940903,-0.150920301675797,-0.152325302362442,-0.165447399020195,-0.153244093060493,-0.15806670486927,-0.16802279651165,-0.178409799933434,-0.183833494782448,-0.162575304508209,-0.162599697709084,-0.173689395189285,-0.170212998986244,-0.166848197579384,-0.166260406374931,-0.17842809855938,-0.0975117981433868,-0.0829029977321625,-0.101552903652191,-0.11262109875679,-0.123274296522141,-0.116216897964478,-0.172720402479172,-0.119723200798035,-0.118467800319195,-0.131739303469658,-0.131008505821228,-0.134654104709625,-0.125960305333138,-0.131887093186378,-0.129745304584503,-0.131469696760178,-0.121338799595833,-0.135445103049278,-0.137537002563477,-0.141436398029327,-0.117013201117516,-0.101044498383999,-0.10912349820137,-0.104285500943661,-0.106341503560543,-0.104715898633003,-0.115418702363968,-0.109950698912144,-0.108051002025604,-0.114294797182083,-0.109049297869205,-0.109813898801804,-0.10696080327034,-0.0730184018611908,-0.143455997109413,-0.123548701405525,-0.123461499810219,-0.0917520001530647,-0.101619601249695,-0.105260796844959,-0.107882797718048,-0.111751697957516,-0.119044497609138,-0.130570992827415,-0.127540901303291,-0.136847898364067,-0.140881896018982,-0.125988394021988,-0.129254505038261,-0.14417290687561,-0.141303792595863,-0.140054807066917,-0.132818803191185,-0.136564701795578,-0.142174899578094,-0.140596807003021,-0.142041102051735,-0.131944105029106,-0.179172202944756,-0.167493104934692,-0.138083204627037,-0.187978401780128,-0.188125595450401,-0.183117806911469,-0.183628305792809,-0.190236896276474,-0.086660198867321,-0.156065493822098,-0.200990095734596,-0.201490193605423,-0.11407820135355,-0.103923097252846,-0.197503104805946,-0.193005800247192,-0.197288200259209,-0.205240100622177,-0.195428803563118,-0.105878598988056,-0.112193301320076,-0.202580004930496,-0.209433004260063,-0.100676998496056,-0.198381707072258,-0.194729894399643,-0.191833004355431,-0.191565096378326,-0.0788919031620026,-0.123250603675842,-0.0845493003726006,-0.0895150005817413,-0.106222197413445,-0.115849301218987,-0.122282296419144,-0.111050099134445,-0.115093097090721,-0.114959798753262,-0.110633701086044,-0.122760303318501,-0.111009202897549,-0.111419402062893,-0.124379597604275,-0.116879597306252,-0.113917402923107,-0.150479704141617,-0.179724097251892,-0.164408206939697,-0.158520206809044,-0.0769961029291153,-0.0900261998176575,-0.179517894983292,-0.0962169021368027,-0.0939660966396332,-0.124270096421242,-0.132357105612755,-0.135017797350883,-0.194334402680397,-0.0973121002316475,-0.161378994584084,-0.135711193084717,-0.138918504118919,-0.130049198865891,-0.131127893924713,-0.0970930978655815,-0.151217997074127,-0.134945601224899,-0.147493600845337,-0.142176300287247,-0.15065510571003,-0.19227659702301,-0.176309496164322,-0.200730696320534,-0.133782297372818,-0.17974080145359,-0.154045194387436,-0.163533195853233,-0.193469405174255,-0.155691504478455,-0.121644802391529,-0.17970509827137,-0.125699892640114,-0.103563599288464,-0.115013100206852,-0.09218680113554,-0.09272850304842,-0.0715885013341904,-0.169783800840378,-0.174565702676773,-0.17051850259304,-0.118133701384068,-0.217499002814293,-0.0417601987719536,-0.0749483034014702,-0.0356981009244919,-0.0466320998966694,-0.0706816986203194,-0.0998281985521317,-0.0998431965708733,-0.0613513998687267,-0.0627153962850571,-0.0984753966331482,-0.122087001800537,-0.118647001683712,-0.173518195748329,-0.0286301001906395,-0.0661886036396027,-0.0427928008139133,-0.0479843989014626,-0.211451902985573,-0.224229201674461,-0.219624802470207,-0.205994099378586,-0.123187303543091,-0.145741403102875,-0.143008604645729,-0.205932304263115,-0.218409404158592,-0.0932016000151634,-0.147731497883797,-0.0373585000634193,-0.114680297672749,-0.115952901542187,-0.115394696593285,-0.113868497312069,-0.113037802278996,-0.183437004685402,-0.187355905771255,-0.190958499908447,-0.0305780004709959,-0.0291713997721672,-0.0929962024092674,-0.068986102938652,-0.111169598996639,-0.107948698103428,-0.0513298995792866,-0.0552406013011932,-0.0548060983419418,-0.0373180992901325,-0.0558837987482548,-0.0334074012935162,-0.0329675003886223,-0.0281582996249199,-0.0254478007555008,-0.0276004001498222,-0.0477617010474205,-0.0358303003013134,-0.174587905406952,-0.0874010026454926,-0.0140482001006603,-0.0336204990744591,-0.0573639012873173,-0.0213794000446796,-0.0124099003151059,-0.141626298427582,-0.0258732996881008,-0.116860397160053,-0.155214801430702,-0.0859581008553505,-0.0855529978871346,-0.0668997019529343,-0.104211002588272,-0.0133453998714685,-0.013314500451088,-0.0133053995668888,-0.0133092002943158,-0.0133496997877955,-0.0133453998714685,-0.0133426999673247,-0.0133788995444775,-0.173877105116844,-0.100308798253536,-0.180845305323601,-0.180836006999016,-0.175301000475883,-0.174712300300598,-0.173866093158722,-0.172882899641991,-0.105443403124809,-0.219121798872948,-0.216540202498436,-0.0288302004337311,-0.0863690003752708,-0.0864045023918152,-0.0863825976848602,-0.0863469988107681,-0.222301796078682,-0.0640854984521866,-0.102562800049782,-0.137372195720673,-0.116579502820969,-0.0469631999731064,-0.0479707010090351,-0.116719298064709,-0.0846550986170769,-0.117624796926975,-0.015591099858284,-0.120800897479057,-0.140801593661308,-0.140767604112625,-0.140485495328903,-0.140521302819252,-0.105547197163105,-0.0800985991954803,-0.0204048994928598,-0.0754837989807129,-0.111793100833893,-0.113653101027012,-0.112904697656631,-0.113424003124237,-0.116502098739147,-0.0584450997412205,-0.0695533007383347,-0.0570680983364582,-0.0579186007380486,-0.229122996330261,-0.214725703001022,-0.0567092001438141,-0.0223765000700951,-0.0744313970208168,-0.144642606377602,-0.172876805067062,-0.217456996440887,-0.217363193631172,-0.217405200004578,-0.041015300899744,-0.0675463974475861,-0.0675292015075684,-0.0677891001105309,-0.0677718967199326,-0.0697977989912033,-0.159299001097679,-0.124966099858284,-0.0694345012307167,-0.0145474001765251,-0.0100236004218459,-0.159067794680595,-0.156053707003593,-0.134881302714348,-0.0216605998575687,-0.0266005005687475,-0.107156299054623,-0.127467095851898,-0.138067096471786,-0.143167093396187,-0.139073401689529,-0.148810297250748,-0.206682801246643,-0.138449296355247,-0.11837849766016,-0.0132076004520059,-0.193282201886177,-0.195741400122643,-0.194131806492805,-0.202047005295753,-0.197559401392937,-0.0259233005344868,-0.0258118994534016,-0.0257335007190704,-0.0257322005927563,-0.0258220005780458,-0.0237387008965015,-0.0237748995423317,-0.0236888006329536,-0.0237250998616219,-0.0107442997395992,-0.00798430014401674,-0.0118950000032783,-0.0417247004806995,-0.136271804571152,-0.0432214997708797,-0.0431764982640743,-0.04341059923172,-0.0432161018252373,-0.0923537015914917,-0.00241909991018474,-0.0069093001075089],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[51.45475251,51.5468254089355],"lng":[-0.236769936,-0.002275]}},"evals":[],"jsHooks":[]}</script>
<p class="caption">
FIGURE 4.4: The spatial distribution of cycle hire points in London based on official data (blue) and OpenStreetMap data (red).
</p>
</div>
<p>Imagine that we need to join the <code>capacity</code> variable in <code>cycle_hire_osm</code> onto the official ‘target’ data contained in <code>cycle_hire</code>.
This is when a non-overlapping join is needed.
The simplest method is to use the topological operator <code>st_is_within_distance()</code> shown in Section <a href="spatial-operations.html#topological-relations">4.2.2</a>, using a threshold distance of 20 m.
Note that, before performing the relation, both objects are transformed into a projected CRS.
These projected objects are created below (note the affix <code>_P</code>, short for projected):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="spatial-operations.html#cb128-1"></a>cycle_hire_P =<span class="st"> </span><span class="kw">st_transform</span>(cycle_hire, <span class="dv">27700</span>)</span>
<span id="cb128-2"><a href="spatial-operations.html#cb128-2"></a>cycle_hire_osm_P =<span class="st"> </span><span class="kw">st_transform</span>(cycle_hire_osm, <span class="dv">27700</span>)</span>
<span id="cb128-3"><a href="spatial-operations.html#cb128-3"></a>sel =<span class="st"> </span><span class="kw">st_is_within_distance</span>(cycle_hire_P, cycle_hire_osm_P, <span class="dt">dist =</span> <span class="dv">20</span>)</span>
<span id="cb128-4"><a href="spatial-operations.html#cb128-4"></a><span class="kw">summary</span>(<span class="kw">lengths</span>(sel) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb128-5"><a href="spatial-operations.html#cb128-5"></a><span class="co">#&gt;    Mode   FALSE    TRUE </span></span>
<span id="cb128-6"><a href="spatial-operations.html#cb128-6"></a><span class="co">#&gt; logical     304     438</span></span></code></pre></div>
<p>This shows that there are 438 points in the target object <code>cycle_hire_P</code> within the threshold distance of <code>cycle_hire_osm_P</code>.
How to retrieve the <em>values</em> associated with the respective <code>cycle_hire_osm_P</code> points?
The solution is again with <code>st_join()</code>, but with an addition <code>dist</code> argument (set to 20 m below):</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="spatial-operations.html#cb129-1"></a>z =<span class="st"> </span><span class="kw">st_join</span>(cycle_hire_P, cycle_hire_osm_P,</span>
<span id="cb129-2"><a href="spatial-operations.html#cb129-2"></a>            <span class="dt">join =</span> st_is_within_distance, <span class="dt">dist =</span> <span class="dv">20</span>)</span>
<span id="cb129-3"><a href="spatial-operations.html#cb129-3"></a><span class="kw">nrow</span>(cycle_hire)</span>
<span id="cb129-4"><a href="spatial-operations.html#cb129-4"></a><span class="co">#&gt; [1] 742</span></span>
<span id="cb129-5"><a href="spatial-operations.html#cb129-5"></a><span class="kw">nrow</span>(z)</span>
<span id="cb129-6"><a href="spatial-operations.html#cb129-6"></a><span class="co">#&gt; [1] 762</span></span></code></pre></div>
<p>Note that the number of rows in the joined result is greater than the target.
This is because some cycle hire stations in <code>cycle_hire_P</code> have multiple matches in <code>cycle_hire_osm_P</code>.
To aggregate the values for the overlapping points and return the mean, we can use the aggregation methods learned in Chapter <a href="attr.html#attr">3</a>, resulting in an object with the same number of rows as the target:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="spatial-operations.html#cb130-1"></a>z =<span class="st"> </span>z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb130-2"><a href="spatial-operations.html#cb130-2"></a><span class="st">  </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb130-3"><a href="spatial-operations.html#cb130-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">capacity =</span> <span class="kw">mean</span>(capacity))</span>
<span id="cb130-4"><a href="spatial-operations.html#cb130-4"></a><span class="kw">nrow</span>(z) <span class="op">==</span><span class="st"> </span><span class="kw">nrow</span>(cycle_hire)</span>
<span id="cb130-5"><a href="spatial-operations.html#cb130-5"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>The capacity of nearby stations can be verified by comparing a plot of the capacity of the source <code>cycle_hire_osm</code> data with the results in this new object (plots not shown):</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="spatial-operations.html#cb131-1"></a><span class="kw">plot</span>(cycle_hire_osm[<span class="st">&quot;capacity&quot;</span>])</span>
<span id="cb131-2"><a href="spatial-operations.html#cb131-2"></a><span class="kw">plot</span>(z[<span class="st">&quot;capacity&quot;</span>])</span></code></pre></div>
<!-- Nearest neighbour analysis -->
<!-- e.g. two point's datasets (non-overlapping) -->
<!-- e.g. two point's datasets (overlapping) -->
<!-- ? topological problems of joining lines/polygons? -->
<!-- joining different types (e.g. points + polygons = geometry) -> save as GPKG? -->
<!-- `merge()`; `st_interpolate_aw()` -->
<p>The result of this join has used a spatial operation to change the attribute data associated with simple features; the geometry associated with each feature has remained unchanged.</p>
</div>
<div id="spatial-aggr" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Spatial data aggregation</h3>
<p>Like attribute data aggregation, covered in Section <a href="attr.html#vector-attribute-aggregation">3.2.2</a>, spatial data aggregation can be a way of <em>condensing</em> data.
Aggregated data show some statistics about a variable (typically average or total) in relation to some kind of <em>grouping variable</em>.
Section <a href="attr.html#vector-attribute-aggregation">3.2.2</a> demonstrated how <code>aggregate()</code> and <code>group_by() %&gt;% summarize()</code> condense data based on attribute variables.
This section demonstrates how the same functions work using spatial grouping variables.
</p>
<p>Returning to the example of New Zealand, imagine you want to find out the average height of high points in each region.
This is a good example of spatial aggregation: it is the geometry of the source (<code>y</code> or <code>nz</code> in this case) that defines how values in the target object (<code>x</code> or <code>nz_height</code>) are grouped.
This is illustrated using the base <code>aggregate()</code> function below:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="spatial-operations.html#cb132-1"></a>nz_avheight =<span class="st"> </span><span class="kw">aggregate</span>(<span class="dt">x =</span> nz_height, <span class="dt">by =</span> nz, <span class="dt">FUN =</span> mean)</span></code></pre></div>
<p>The result of the previous command is an <code>sf</code> object with the same geometry as the (spatial) aggregating object (<code>nz</code>).<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>
The result of the previous operation is illustrated in Figure <a href="spatial-operations.html#fig:spatial-aggregation">4.5</a>.
The same result can also be generated using the ‘tidy’ functions <code>group_by()</code> and <code>summarize()</code> (used in combination with <code>st_join()</code>):</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:spatial-aggregation"></span>
<img src="04-spatial-operations_files/figure-html/spatial-aggregation-1.png" alt="Average height of the top 101 high points across the regions of New Zealand." width="50%" />
<p class="caption">
FIGURE 4.5: Average height of the top 101 high points across the regions of New Zealand.
</p>
</div>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="spatial-operations.html#cb133-1"></a>nz_avheight2 =<span class="st"> </span>nz <span class="op">%&gt;%</span></span>
<span id="cb133-2"><a href="spatial-operations.html#cb133-2"></a><span class="st">  </span><span class="kw">st_join</span>(nz_height) <span class="op">%&gt;%</span></span>
<span id="cb133-3"><a href="spatial-operations.html#cb133-3"></a><span class="st">  </span><span class="kw">group_by</span>(Name) <span class="op">%&gt;%</span></span>
<span id="cb133-4"><a href="spatial-operations.html#cb133-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">elevation =</span> <span class="kw">mean</span>(elevation, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p>The resulting <code>nz_avheight</code> objects have the same geometry as the aggregating object <code>nz</code> but with a new column representing the mean average height of points within each region of New Zealand (other summary functions such as <code>median()</code> and <code>sd()</code> can be used in place of <code>mean()</code>).
Note that regions containing no points have an associated <code>elevation</code> value of <code>NA</code>.
For aggregating operations which also create new geometries, see Section <a href="geometric-operations.html#geometry-unions">5.2.6</a>.</p>
<p>Spatial congruence is an important concept related to spatial aggregation.
An <em>aggregating object</em> (which we will refer to as <code>y</code>) is <em>congruent</em> with the target object (<code>x</code>) if the two objects have shared borders.
Often this is the case for administrative boundary data, whereby larger units — such as Middle Layer Super Output Areas (<a href="https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography">MSOAs</a>) in the UK or districts in many other European countries — are composed of many smaller units.</p>
<p><em>Incongruent</em> aggregating objects, by contrast, do not share common borders with the target <span class="citation">(Qiu, Zhang, and Zhou <a href="#ref-qiu_development_2012" role="doc-biblioref">2012</a>)</span>.
This is problematic for spatial aggregation (and other spatial operations) illustrated in Figure <a href="spatial-operations.html#fig:areal-example">4.6</a>.
Areal interpolation overcomes this issue by transferring values from one set of areal units to another.
Algorithms developed for this task include area weighted and ‘pycnophylactic’ areal interpolation methods <span class="citation">(Tobler <a href="#ref-tobler_smooth_1979" role="doc-biblioref">1979</a>)</span>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:areal-example"></span>
<img src="04-spatial-operations_files/figure-html/areal-example-1.png" alt="Illustration of congruent (left) and incongruent (right) areal units with respect to larger aggregating zones (translucent blue borders)." width="100%" />
<p class="caption">
FIGURE 4.6: Illustration of congruent (left) and incongruent (right) areal units with respect to larger aggregating zones (translucent blue borders).
</p>
</div>
<p>The <strong>spData</strong> package contains a dataset named <code>incongruent</code> (colored polygons with black borders in the right panel of Figure <a href="spatial-operations.html#fig:areal-example">4.6</a>) and a dataset named <code>aggregating_zones</code> (the two polygons with the translucent blue border in the right panel of Figure <a href="spatial-operations.html#fig:areal-example">4.6</a>).
Let us assume that the <code>value</code> column of <code>incongruent</code> refers to the total regional income in million Euros.
How can we transfer the values of the underlying nine spatial polygons into the two polygons of <code>aggregating_zones</code>?</p>
<p>The simplest useful method for this is <em>area weighted</em> spatial interpolation.
In this case values from the <code>incongruent</code> object are allocated to the <code>aggregating_zones</code> in proportion to area; the larger the spatial intersection between input and output features, the larger the corresponding value.
For instance, if one intersection of <code>incongruent</code> and <code>aggregating_zones</code> is 1.5 km<sup>2</sup> but the whole incongruent polygon in question has 2 km<sup>2</sup> and a total income of 4 million Euros, then the target aggregating zone will obtain three quarters of the income, in this case 3 million Euros.
This is implemented in <code>st_interpolate_aw()</code>, as demonstrated in the code chunk below.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="spatial-operations.html#cb134-1"></a>agg_aw =<span class="st"> </span><span class="kw">st_interpolate_aw</span>(incongruent[, <span class="st">&quot;value&quot;</span>], aggregating_zones,</span>
<span id="cb134-2"><a href="spatial-operations.html#cb134-2"></a>                           <span class="dt">extensive =</span> <span class="ot">TRUE</span>)</span>
<span id="cb134-3"><a href="spatial-operations.html#cb134-3"></a><span class="co">#&gt; Warning in st_interpolate_aw.sf(incongruent[, &quot;value&quot;], aggregating_zones, :</span></span>
<span id="cb134-4"><a href="spatial-operations.html#cb134-4"></a><span class="co">#&gt; st_interpolate_aw assumes attributes are constant or uniform over areas of x</span></span>
<span id="cb134-5"><a href="spatial-operations.html#cb134-5"></a><span class="co"># show the aggregated result</span></span>
<span id="cb134-6"><a href="spatial-operations.html#cb134-6"></a>agg_aw<span class="op">$</span>value</span>
<span id="cb134-7"><a href="spatial-operations.html#cb134-7"></a><span class="co">#&gt; [1] 19.6 25.7</span></span></code></pre></div>
<p>In our case it is meaningful to sum up the values of the intersections falling into the aggregating zones since total income is a so-called spatially extensive variable.
This would be different for spatially intensive variables, which are independent of the spatial units used, such as income per head or <a href="http://ibis.geog.ubc.ca/courses/geob370/notes/intensive_extensive.htm">percentages</a>.
In this case it is more meaningful to apply an average function when doing the aggregation instead of a sum function.
To do so, one would only have to set the <code>extensive</code> parameter to <code>FALSE</code>.</p>
<!-- - `aggregate.sf()` - aggregate an sf object, possibly union-ing geometries -->
<!-- - disaggregation?? `st_cast()` - https://github.com/edzer/sfr/wiki/migrating -->
<!-- - `group_by()` + `summarise()` - potential errors -->
<!-- - ? generalization **rmapsharper** - https://github.com/ateucher/rmapshaper -->
<!-- `st_union` -->
</div>
<div id="distance-relations" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Distance relations</h3>
<p>While topological relations are binary — a feature either intersects with another or does not — distance relations are continuous.
The distance between two objects is calculated with the <code>st_distance()</code> function.
This is illustrated in the code chunk below, which finds the distance between the highest point in New Zealand and the geographic centroid of the Canterbury region, created in Section <a href="spatial-operations.html#spatial-subsetting">4.2.1</a>:
</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="spatial-operations.html#cb135-1"></a>nz_heighest =<span class="st"> </span>nz_height <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">wt =</span> elevation)</span>
<span id="cb135-2"><a href="spatial-operations.html#cb135-2"></a>canterbury_centroid =<span class="st"> </span><span class="kw">st_centroid</span>(canterbury)</span>
<span id="cb135-3"><a href="spatial-operations.html#cb135-3"></a><span class="kw">st_distance</span>(nz_heighest, canterbury_centroid)</span>
<span id="cb135-4"><a href="spatial-operations.html#cb135-4"></a><span class="co">#&gt; Units: [m]</span></span>
<span id="cb135-5"><a href="spatial-operations.html#cb135-5"></a><span class="co">#&gt;        [,1]</span></span>
<span id="cb135-6"><a href="spatial-operations.html#cb135-6"></a><span class="co">#&gt; [1,] 115540</span></span></code></pre></div>
<p>There are two potentially surprising things about the result:</p>
<ul>
<li>It has <code>units</code>, telling us the distance is 100,000 meters, not 100,000 inches, or any other measure of distance</li>
<li>It is returned as a matrix, even though the result only contains a single value</li>
</ul>
<p>This second feature hints at another useful feature of <code>st_distance()</code>, its ability to return <em>distance matrices</em> between all combinations of features in objects <code>x</code> and <code>y</code>.
This is illustrated in the command below, which finds the distances between the first three features in <code>nz_height</code> and the Otago and Canterbury regions of New Zealand represented by the object <code>co</code>.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="spatial-operations.html#cb136-1"></a>co =<span class="st"> </span><span class="kw">filter</span>(nz, <span class="kw">grepl</span>(<span class="st">&quot;Canter|Otag&quot;</span>, Name))</span>
<span id="cb136-2"><a href="spatial-operations.html#cb136-2"></a><span class="kw">st_distance</span>(nz_height[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, ], co)</span>
<span id="cb136-3"><a href="spatial-operations.html#cb136-3"></a><span class="co">#&gt; Units: [m]</span></span>
<span id="cb136-4"><a href="spatial-operations.html#cb136-4"></a><span class="co">#&gt;        [,1]  [,2]</span></span>
<span id="cb136-5"><a href="spatial-operations.html#cb136-5"></a><span class="co">#&gt; [1,] 123537 15498</span></span>
<span id="cb136-6"><a href="spatial-operations.html#cb136-6"></a><span class="co">#&gt; [2,]  94283     0</span></span>
<span id="cb136-7"><a href="spatial-operations.html#cb136-7"></a><span class="co">#&gt; [3,]  93019     0</span></span></code></pre></div>
<p>Note that the distance between the second and third features in <code>nz_height</code> and the second feature in <code>co</code> is zero.
This demonstrates the fact that distances between points and polygons refer to the distance to <em>any part of the polygon</em>:
The second and third points in <code>nz_height</code> are <em>in</em> Otago, which can be verified by plotting them (result not shown):</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="spatial-operations.html#cb137-1"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(co)[<span class="dv">2</span>])</span>
<span id="cb137-2"><a href="spatial-operations.html#cb137-2"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nz_height)[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>], <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="spatial-ras" class="section level2">
<h2><span class="header-section-number">4.3</span> Spatial operations on raster data</h2>
<p>This section builds on Section <a href="attr.html#manipulating-raster-objects">3.3</a>, which highlights various basic methods for manipulating raster datasets, to demonstrate more advanced and explicitly spatial raster operations, and uses the objects <code>elev</code> and <code>grain</code> manually created in Section <a href="attr.html#manipulating-raster-objects">3.3</a>.
For the reader’s convenience, these datasets can be also found in the <strong>spData</strong> package.</p>
<div id="spatial-raster-subsetting" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Spatial subsetting</h3>
<p>The previous chapter (Section <a href="attr.html#manipulating-raster-objects">3.3</a>) demonstrated how to retrieve values associated with specific cell IDs or row and column combinations.
Raster objects can also be extracted by location (coordinates) and other spatial objects.
To use coordinates for subsetting, one can ‘translate’ the coordinates into a cell ID with the <strong>raster</strong> function <code>cellFromXY()</code>.
An alternative is to use <code>raster::extract()</code> (be careful, there is also a function called <code>extract()</code> in the <strong>tidyverse</strong>) to extract values.
Both methods are demonstrated below to find the value of the cell that covers a point located 0.1 units from the origin.

</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="spatial-operations.html#cb138-1"></a>id =<span class="st"> </span><span class="kw">cellFromXY</span>(elev, <span class="dt">xy =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb138-2"><a href="spatial-operations.html#cb138-2"></a>elev[id]</span>
<span id="cb138-3"><a href="spatial-operations.html#cb138-3"></a><span class="co"># the same as</span></span>
<span id="cb138-4"><a href="spatial-operations.html#cb138-4"></a>raster<span class="op">::</span><span class="kw">extract</span>(elev, <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="fl">0.1</span>, <span class="dt">y =</span> <span class="fl">0.1</span>))</span></code></pre></div>
<p>It is convenient that both functions also accept objects of class <code>Spatial* Objects</code>.
Raster objects can also be subset with another raster object, as illustrated in Figure <a href="spatial-operations.html#fig:raster-subset">4.7</a> (left panel) and demonstrated in the code chunk below:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="spatial-operations.html#cb139-1"></a>clip =<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="fl">0.9</span>, <span class="dt">xmx =</span> <span class="fl">1.8</span>, <span class="dt">ymn =</span> <span class="fl">-0.45</span>, <span class="dt">ymx =</span> <span class="fl">0.45</span>,</span>
<span id="cb139-2"><a href="spatial-operations.html#cb139-2"></a>              <span class="dt">res =</span> <span class="fl">0.3</span>, <span class="dt">vals =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb139-3"><a href="spatial-operations.html#cb139-3"></a>elev[clip]</span>
<span id="cb139-4"><a href="spatial-operations.html#cb139-4"></a><span class="co">#&gt; [1] 18 24</span></span>
<span id="cb139-5"><a href="spatial-operations.html#cb139-5"></a><span class="co"># we can also use extract</span></span>
<span id="cb139-6"><a href="spatial-operations.html#cb139-6"></a><span class="co"># extract(elev, extent(clip))</span></span></code></pre></div>
<p>Basically, this amounts to retrieving the values of the first raster (here: <code>elev</code>) falling within the extent of a second raster (here: <code>clip</code>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:raster-subset"></span>
<img src="figures/04_raster_subset.png" alt="Subsetting raster values with the help of another raster (left). Raster mask (middle). Output of masking a raster (right)." width="100%" />
<p class="caption">
FIGURE 4.7: Subsetting raster values with the help of another raster (left). Raster mask (middle). Output of masking a raster (right).
</p>
</div>
<p>So far, the subsetting returned the values of specific cells, however, when doing spatial subsetting, one often also expects a spatial object as an output.
To do this, we can use again the <code>[</code> when we additionally set the <code>drop</code> parameter to <code>FALSE</code>.
To illustrate this, we retrieve the first two cells of <code>elev</code> as an individual raster object.
As mentioned in Section <a href="attr.html#manipulating-raster-objects">3.3</a>, the <code>[</code> operator accepts various inputs to subset rasters and returns a raster object when <code>drop = FALSE</code>.
The code chunk below subsets the <code>elev</code> raster by cell ID and row-column index with identical results: the first two cells on the top row (only the first 2 lines of the output is shown):</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="spatial-operations.html#cb140-1"></a>elev[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, drop =<span class="st"> </span><span class="ot">FALSE</span>]    <span class="co"># spatial subsetting with cell IDs</span></span>
<span id="cb140-2"><a href="spatial-operations.html#cb140-2"></a>elev[<span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, drop =<span class="st"> </span><span class="ot">FALSE</span>] <span class="co"># spatial subsetting by row,column indices</span></span>
<span id="cb140-3"><a href="spatial-operations.html#cb140-3"></a><span class="co">#&gt; class       : RasterLayer </span></span>
<span id="cb140-4"><a href="spatial-operations.html#cb140-4"></a><span class="co">#&gt; dimensions  : 1, 2, 2  (nrow, ncol, ncell)</span></span>
<span id="cb140-5"><a href="spatial-operations.html#cb140-5"></a><span class="co">#&gt; ...</span></span></code></pre></div>
<p>Another common use case of spatial subsetting is when a raster with <code>logical</code> (or <code>NA</code>) values is used to mask another raster with the same extent and resolution, as illustrated in Figure <a href="spatial-operations.html#fig:raster-subset">4.7</a>, middle and right panel.
In this case, the <code>[</code>, <code>mask()</code> and <code>overlay()</code> functions can be used (results not shown):</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="spatial-operations.html#cb141-1"></a><span class="co"># create raster mask</span></span>
<span id="cb141-2"><a href="spatial-operations.html#cb141-2"></a>rmask =<span class="st"> </span>elev </span>
<span id="cb141-3"><a href="spatial-operations.html#cb141-3"></a><span class="kw">values</span>(rmask) =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="ot">NA</span>, <span class="ot">TRUE</span>), <span class="dv">36</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb141-4"><a href="spatial-operations.html#cb141-4"></a></span>
<span id="cb141-5"><a href="spatial-operations.html#cb141-5"></a><span class="co"># spatial subsetting</span></span>
<span id="cb141-6"><a href="spatial-operations.html#cb141-6"></a>elev[rmask, drop =<span class="st"> </span><span class="ot">FALSE</span>]           <span class="co"># with [ operator</span></span>
<span id="cb141-7"><a href="spatial-operations.html#cb141-7"></a><span class="kw">mask</span>(elev, rmask)                   <span class="co"># with mask()</span></span>
<span id="cb141-8"><a href="spatial-operations.html#cb141-8"></a><span class="kw">overlay</span>(elev, rmask, <span class="dt">fun =</span> <span class="st">&quot;max&quot;</span>)   <span class="co"># with overlay</span></span></code></pre></div>
<p>In the code chunk above, we have created a mask object called <code>rmask</code> with values randomly assigned to <code>NA</code> and <code>TRUE</code>.
Next, we want to keep those values of <code>elev</code> which are <code>TRUE</code> in <code>rmask</code>.
In other words, we want to mask <code>elev</code> with <code>rmask</code>.
These operations are in fact Boolean local operations since we compare cell-wise two rasters.
The next subsection explores these and related operations in more detail.</p>
</div>
<div id="map-algebra" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Map algebra</h3>
<p>
Map algebra makes raster processing really fast.
This is because raster datasets only implicitly store coordinates.
To derive the coordinate of a specific cell, we have to calculate it using its matrix position and the raster resolution and origin.
For the processing, however, the geographic position of a cell is barely relevant as long as we make sure that the cell position is still the same after the processing (one-to-one locational correspondence).
Additionally, if two or more raster datasets share the same extent, projection and resolution, one could treat them as matrices for the processing.
This is exactly what map algebra is doing in R.
First, the <strong>raster</strong> package checks the headers of the rasters on which to perform any algebraic operation, and only if they are correspondent to each other, the processing goes on.<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>
And secondly, map algebra retains the so-called one-to-one locational correspondence.
This is where it substantially differs from matrix algebra which changes positions when for example multiplying or dividing matrices.</p>
<p>Map algebra (or cartographic modeling) divides raster operations into four subclasses <span class="citation">(Tomlin <a href="#ref-tomlin_geographic_1990" role="doc-biblioref">1990</a>)</span>, with each working on one or several grids simultaneously:</p>
<ol style="list-style-type: decimal">
<li><em>Local</em> or per-cell operations.</li>
<li><em>Focal</em> or neighborhood operations.
Most often the output cell value is the result of a 3 x 3 input cell block.</li>
<li><em>Zonal</em> operations are similar to focal operations, but the surrounding pixel grid on which new values are computed can have irregular sizes and shapes.
<!-- sentence structure could be confusing in the sentence above --></li>
<li><em>Global</em> or per-raster operations; that means the output cell derives its value potentially from one or several entire rasters.</li>
</ol>
<p>This typology classifies map algebra operations by the number/shape of cells used for each pixel processing step.
For the sake of completeness, we should mention that raster operations can also be classified by discipline such as terrain, hydrological analysis or image classification.
The following sections explain how each type of map algebra operations can be used, with reference to worked examples (also see <code>vignette("Raster")</code> for a technical description of map algebra).</p>
</div>
<div id="local-operations" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Local operations</h3>
<p>
<strong>Local</strong> operations comprise all cell-by-cell operations in one or several layers.
A good example is the classification of intervals of numeric values into groups such as grouping a digital elevation model into low (class 1), middle (class 2) and high elevations (class 3).
Using the <code>reclassify()</code> command, we need first to construct a reclassification matrix, where the first column corresponds to the lower and the second column to the upper end of the class.
The third column represents the new value for the specified ranges in column one and two.
Here, we assign the raster values in the ranges 0–12, 12–24 and 24–36 are <em>reclassified</em> to take values 1, 2 and 3, respectively.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="spatial-operations.html#cb142-1"></a>rcl =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">2</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</span>
<span id="cb142-2"><a href="spatial-operations.html#cb142-2"></a>recl =<span class="st"> </span><span class="kw">reclassify</span>(elev, <span class="dt">rcl =</span> rcl)</span></code></pre></div>
<p>We will perform several reclassifactions in Chapter <a href="location.html#location">13</a>.</p>
<p>Raster algebra is another classical use case of local operations.
This includes adding, subtracting and squaring two rasters.
Raster algebra also allows logical operations such as finding all raster cells that are greater than a specific value (5 in our example below).
The <strong>raster</strong> package supports all these operations and more, as described in <code>vignette("Raster")</code> and demonstrated below (results not shown):</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="spatial-operations.html#cb143-1"></a>elev <span class="op">+</span><span class="st"> </span>elev</span>
<span id="cb143-2"><a href="spatial-operations.html#cb143-2"></a>elev<span class="op">^</span><span class="dv">2</span></span>
<span id="cb143-3"><a href="spatial-operations.html#cb143-3"></a><span class="kw">log</span>(elev)</span>
<span id="cb143-4"><a href="spatial-operations.html#cb143-4"></a>elev <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span></span></code></pre></div>
<p>Instead of arithmetic operators, one can also use the <code>calc()</code> and <code>overlay()</code> functions.
These functions are more efficient, hence, they are preferable in the presence of large raster datasets.
Additionally, they allow you to directly store an output file.</p>
<p>The calculation of the normalized difference vegetation index (NDVI) is a well-known local (pixel-by-pixel) raster operation.
It returns a raster with values between -1 and 1; positive values indicate the presence of living plants (mostly &gt; 0.2).
NDVI is calculated from red and near-infrared (NIR) bands of remotely sensed imagery, typically from satellite systems such as Landsat or Sentinel.
Vegetation absorbs light heavily in the visible light spectrum, and especially in the red channel, while reflecting NIR light, explaining the NVDI formula:</p>
<p><span class="math display">\[
\begin{split}
NDVI&amp;= \frac{\text{NIR} - \text{Red}}{\text{NIR} + \text{Red}}\\
\end{split}
\]</span></p>
<p>Predictive mapping is another interesting application of local raster operations.
The response variable corresponds to measured or observed points in space, for example, species richness, the presence of landslides, tree disease or crop yield.
Consequently, we can easily retrieve space- or airborne predictor variables from various rasters (elevation, pH, precipitation, temperature, landcover, soil class, etc.).
Subsequently, we model our response as a function of our predictors using <code>lm</code>, <code>glm</code>, <code>gam</code> or a machine-learning technique.
Spatial predictions on raster objects can therefore be made by applying estimated coefficients to the predictor raster values, and summing the output raster values (see Chapter <a href="eco.html#eco">14</a>).</p>
</div>
<div id="focal-operations" class="section level3">
<h3><span class="header-section-number">4.3.4</span> Focal operations</h3>
<p>
While local functions operate on one cell, though possibly from multiple layers, <strong>focal</strong> operations take into account a central cell and its neighbors.
The neighborhood (also named kernel, filter or moving window) under consideration is typically of size 3-by-3 cells (that is the central cell and its eight surrounding neighbors), but can take on any other (not necessarily rectangular) shape as defined by the user.
A focal operation applies an aggregation function to all cells within the specified neighborhood, uses the corresponding output as the new value for the the central cell, and moves on to the next central cell (Figure <a href="spatial-operations.html#fig:focal-example">4.8</a>).
Other names for this operation are spatial filtering and convolution <span class="citation">(Burrough, McDonnell, and Lloyd <a href="#ref-burrough_principles_2015" role="doc-biblioref">2015</a>)</span>.</p>
<p>In R, we can use the <code>focal()</code> function to perform spatial filtering.
We define the shape of the moving window with a <code>matrix</code> whose values correspond to weights (see <code>w</code> parameter in the code chunk below).
Secondly, the <code>fun</code> parameter lets us specify the function we wish to apply to this neighborhood.
Here, we choose the minimum, but any other summary function, including <code>sum()</code>, <code>mean()</code>, or <code>var()</code> can be used.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="spatial-operations.html#cb144-1"></a>r_focal =<span class="st"> </span><span class="kw">focal</span>(elev, <span class="dt">w =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">ncol =</span> <span class="dv">3</span>), <span class="dt">fun =</span> min)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:focal-example"></span>
<img src="figures/04_focal_example.png" alt="Input raster (left) and resulting output raster (right) due to a focal operation - finding the minimum value in 3-by-3 moving windows." width="100%" />
<p class="caption">
FIGURE 4.8: Input raster (left) and resulting output raster (right) due to a focal operation - finding the minimum value in 3-by-3 moving windows.
</p>
</div>
<p>We can quickly check if the output meets our expectations.
In our example, the minimum value has to be always the upper left corner of the moving window (remember we have created the input raster by row-wise incrementing the cell values by one starting at the upper left corner).
In this example, the weighting matrix consists only of 1s, meaning each cell has the same weight on the output, but this can be changed.</p>
<p>Focal functions or filters play a dominant role in image processing.
Low-pass or smoothing filters use the mean function to remove extremes.
In the case of categorical data, we can replace the mean with the mode, which is the most common value.
By contrast, high-pass filters accentuate features.
The line detection Laplace and Sobel filters might serve as an example here.
Check the <code>focal()</code> help page for how to use them in R (this will also be used in the exercises at the end of this chapter).</p>
<p>Terrain processing, the calculation of topographic characteristics such as slope, aspect and flow directions, relies on focal functions.
<code>terrain()</code> can be used to calculate these metrics, although some terrain algorithms, including the Zevenbergen and Thorne method to compute slope, are not implemented in this <strong>raster</strong> function.
Many other algorithms — including curvatures, contributing areas and wetness indices — are implemented in open source desktop geographic information system (GIS) software.
Chapter <a href="gis.html#gis">9</a> shows how to access such GIS functionality from within R.</p>
</div>
<div id="zonal-operations" class="section level3">
<h3><span class="header-section-number">4.3.5</span> Zonal operations</h3>
<p>
Just like focal operations, <em>zonal</em> operations apply an aggregation function to multiple raster cells.
However, a second raster, usually a categorical raster, defines the <em>zonal filters</em> (or ‘zones’) in the case of zonal operations as opposed to a predefined neighborhood window in the case of focal operations (see previous Section).
Consequently, the raster cells defining the zonal filter do not necessarily have to be neighbors.
Our grain size raster is a good example (right panel of Figure <a href="attr.html#fig:cont-raster">3.2</a>) because the different grain sizes are spread in an irregular fashion throughout the raster.
Finally, the result of a zonal operation is a summary table grouped by zone which is why this operation is also known as <em>zonal statistics</em> in the GIS world.
This is in contrast to focal operations which return a raster object (see previous Section).</p>
<p>For example, to find the mean elevation for each grain size class (Figure <a href="attr.html#fig:cont-raster">3.2</a>), we use the <code>zonal()</code> function.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="spatial-operations.html#cb145-1"></a>z =<span class="st"> </span><span class="kw">zonal</span>(elev, grain, <span class="dt">fun =</span> <span class="st">&quot;mean&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb145-2"><a href="spatial-operations.html#cb145-2"></a><span class="st">  </span><span class="kw">as.data.frame</span>()</span>
<span id="cb145-3"><a href="spatial-operations.html#cb145-3"></a>z</span>
<span id="cb145-4"><a href="spatial-operations.html#cb145-4"></a><span class="co">#&gt;   zone mean</span></span>
<span id="cb145-5"><a href="spatial-operations.html#cb145-5"></a><span class="co">#&gt; 1    1 17.8</span></span>
<span id="cb145-6"><a href="spatial-operations.html#cb145-6"></a><span class="co">#&gt; 2    2 18.5</span></span>
<span id="cb145-7"><a href="spatial-operations.html#cb145-7"></a><span class="co">#&gt; 3    3 19.2</span></span></code></pre></div>
<p>This returns the statistics for each category, here the mean altitude for each grain size class, and can be added to the attribute table of the ratified raster (see previous chapter).</p>
</div>
<div id="global-operations-and-distances" class="section level3">
<h3><span class="header-section-number">4.3.6</span> Global operations and distances</h3>
<p><em>Global</em> operations are a special case of zonal operations with the entire raster dataset representing a single zone.
The most common global operations are descriptive statistics for the entire raster dataset such as the minimum or maximum (see Section <a href="attr.html#summarizing-raster-objects">3.3.2</a>).
Aside from that, global operations are also useful for the computation of distance and weight rasters.
In the first case, one can calculate the distance from each cell to a specific target cell.
For example, one might want to compute the distance to the nearest coast (see also <code>raster::distance()</code>).
We might also want to consider topography, that means, we are not only interested in the pure distance but would like also to avoid the crossing of mountain ranges when going to the coast.
To do so, we can weight the distance with elevation so that each additional altitudinal meter ‘prolongs’ the Euclidean distance.
Visibility and viewshed computations also belong to the family of global operations (in the exercises of Chapter <a href="gis.html#gis">9</a>, you will compute a viewshed raster).</p>
</div>
<div id="map-algebra-counterparts-in-vector-processing" class="section level3">
<h3><span class="header-section-number">4.3.7</span> Map algebra counterparts in vector processing</h3>
<p>Many map algebra operations have a counterpart in vector processing <span class="citation">(Liu and Mason <a href="#ref-liu_essential_2009" role="doc-biblioref">2009</a>)</span>.
Computing a distance raster (zonal operation) while only considering a maximum distance (logical focal operation) is the equivalent to a vector buffer operation (Section <a href="geometric-operations.html#clipping">5.2.5</a>).
Reclassifying raster data (either local or zonal function depending on the input) is equivalent to dissolving vector data (Section <a href="spatial-operations.html#spatial-joining">4.2.3</a>).
Overlaying two rasters (local operation), where one contains <code>NULL</code> or <code>NA</code> values representing a mask, is similar to vector clipping (Section <a href="geometric-operations.html#clipping">5.2.5</a>).
Quite similar to spatial clipping is intersecting two layers (Section <a href="spatial-operations.html#spatial-subsetting">4.2.1</a>).
The difference is that these two layers (vector or raster) simply share an overlapping area (see Figure <a href="geometric-operations.html#fig:venn-clip">5.8</a> for an example).
However, be careful with the wording.
Sometimes the same words have slightly different meanings for raster and vector data models.
Aggregating in the case of vector data refers to dissolving polygons, while it means increasing the resolution in the case of raster data.
In fact, one could see dissolving or aggregating polygons as decreasing the resolution.
However, zonal operations might be the better raster equivalent compared to changing the cell resolution.
Zonal operations can dissolve the cells of one raster in accordance with the zones (categories) of another raster using an aggregation function (see above).</p>
</div>
<div id="merging-rasters" class="section level3">
<h3><span class="header-section-number">4.3.8</span> Merging rasters</h3>
<p>
Suppose we would like to compute the NDVI (see Section <a href="spatial-operations.html#local-operations">4.3.3</a>), and additionally want to compute terrain attributes from elevation data for observations within a study area.
Such computations rely on remotely sensed information.
The corresponding imagery is often divided into scenes covering a specific spatial extent.
Frequently, a study area covers more than one scene.
In these cases we would like to merge the scenes covered by our study area.
In the easiest case, we can just merge these scenes, that is put them side by side.
This is possible with digital elevation data (SRTM, ASTER).
In the following code chunk we first download the SRTM elevation data for Austria and Switzerland (for the country codes, see the <strong>raster</strong> function <code>ccodes()</code>).
In a second step, we merge the two rasters into one.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="spatial-operations.html#cb146-1"></a>aut =<span class="st"> </span><span class="kw">getData</span>(<span class="st">&quot;alt&quot;</span>, <span class="dt">country =</span> <span class="st">&quot;AUT&quot;</span>, <span class="dt">mask =</span> <span class="ot">TRUE</span>)</span>
<span id="cb146-2"><a href="spatial-operations.html#cb146-2"></a>ch =<span class="st"> </span><span class="kw">getData</span>(<span class="st">&quot;alt&quot;</span>, <span class="dt">country =</span> <span class="st">&quot;CHE&quot;</span>, <span class="dt">mask =</span> <span class="ot">TRUE</span>)</span>
<span id="cb146-3"><a href="spatial-operations.html#cb146-3"></a>aut_ch =<span class="st"> </span><span class="kw">merge</span>(aut, ch)</span></code></pre></div>
<p><strong>Raster</strong>’s <code>merge()</code> command combines two images, and in case they overlap, it uses the value of the first raster.
You can do exactly the same with <code>gdalUtils::mosaic_rasters()</code> which is faster, and therefore recommended if you have to merge a multitude of large rasters stored on disk.</p>
<p>The merging approach is of little use when the overlapping values do not correspond to each other.
This is frequently the case when you want to combine spectral imagery from scenes that were taken on different dates.
The <code>merge()</code> command will still work but you will see a clear border in the resulting image.
The <code>mosaic()</code> command lets you define a function for the overlapping area.
For instance, we could compute the mean value.
This might smooth the clear border in the merged result but it will most likely not make it disappear.
To do so, we need a more advanced approach.
Remote sensing scientists frequently apply histogram matching or use regression techniques to align the values of the first image with those of the second image.
The packages <strong>landsat</strong> (<code>histmatch()</code>, <code>relnorm()</code>, <code>PIF()</code>), <strong>satellite</strong> (<code>calcHistMatch()</code>) and <strong>RStoolbox</strong> (<code>histMatch()</code>, <code>pifMatch()</code>) provide the corresponding functions.
For a more detailed introduction on how to use R for remote sensing, we refer the reader to <span class="citation">Wegmann, Leutner, and Dech (<a href="#ref-wegmann_remote_2016" role="doc-biblioref">2016</a>)</span>.</p>
<!-- ## Spatial data creation -->
<!-- where should "area" example be? in this or the previous chapter? -->
<!-- Not here - I think this chapter should focus on geomtry data -->
<!-- `st_centroid()` -->
<!-- `st_buffer()` -->
<!-- http://r-spatial.org//r/2017/06/09/mapedit_0-2-0.html -->
<!-- Commented out - think this would be better in c3 (RL) -->
<!-- ```{r} -->
<!-- # add a new column -->
<!-- africa$area = set_units(st_area(africa), value = km^2) -->
<!-- africa$pop_density = africa$pop / africa$area -->
<!-- # OR -->
<!-- africa = africa %>% -->
<!--         mutate(area = set_units(st_area(.), value = km^2)) %>% -->
<!--         mutate(pop_density = pop / area) -->
<!-- ``` -->
<!-- Note that this has created a attributes for the area and population density variables: -->
<!-- ```{r} -->
<!-- attributes(africa$area) -->
<!-- attributes(africa$pop_density) -->
<!-- ``` -->
<!-- These can be set to `NULL` as follows: -->
<!-- ```{r} -->
<!-- attributes(africa$area) = NULL -->
<!-- attributes(africa$pop_density) = NULL -->
<!-- ``` -->
<!-- ## Spatial data transformation -->
<!-- changes classes; polygonize, etc-->
</div>
</div>
<div id="exercises-2" class="section level2">
<h2><span class="header-section-number">4.4</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li><p>It was established in Section <a href="spatial-operations.html#spatial-vec">4.2</a> that Canterbury was the region of New Zealand containing most of the 100 highest points in the country.
How many of these high points does the Canterbury region contain?</p></li>
<li><p>Which region has the second highest number of <code>nz_height</code> points in, and how many does it have?</p></li>
<li><p>Generalizing the question to all regions: how many of New Zealand’s 16 regions contain points which belong to the top 100 highest points in the country? Which regions?</p>
<ul>
<li>Bonus: create a table listing these regions in order of the number of points and their name.</li>
</ul></li>
<li><p>Use <code>data(dem, package = "spDataLarge")</code>, and reclassify the elevation in three classes: low, medium and high.
Secondly, attach the NDVI raster (<code>data(ndvi, package = "spDataLarge")</code>) and compute the mean NDVI and the mean elevation for each altitudinal class.</p></li>
<li><p>Apply a line detection filter to <code>raster(system.file("external/rlogo.grd", package = "raster"))</code>.
Plot the result.
Hint: Read <code>?raster::focal()</code>.</p></li>
<li><p>Calculate the NDVI of a Landsat image.
Use the Landsat image provided by the <strong>spDataLarge</strong> package (<code>system.file("raster/landsat.tif", package="spDataLarge")</code>).</p></li>
<li><p>A StackOverflow <a href="https://stackoverflow.com/questions/35555709/global-raster-of-geographic-distances">post</a> shows how to compute distances to the nearest coastline using <code>raster::distance()</code>.
Retrieve a digital elevation model of Spain, and compute a raster which represents distances to the coast across the country (hint: use <code>getData()</code>).
Second, use a simple approach to weight the distance raster with elevation (other weighting approaches are possible, include flow direction and steepness); every 100 altitudinal meters should increase the distance to the coast by 10 km.
Finally, compute the difference between the raster using the Euclidean distance and the raster weighted by elevation.
Note: it may be wise to increase the cell size of the input raster to reduce compute time during this operation.</p></li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-burrough_principles_2015">
<p>Burrough, P. A., Rachael McDonnell, and Christopher D. Lloyd. 2015. <em>Principles of Geographical Information Systems</em>. Third. Oxford, New York: Oxford University Press.</p>
</div>
<div id="ref-liu_essential_2009">
<p>Liu, Jian-Guo, and Philippa J. Mason. 2009. <em>Essential Image Processing and GIS for Remote Sensing</em>. Chichester, West Sussex, UK, Hoboken, NJ: Wiley-Blackwell.</p>
</div>
<div id="ref-qiu_development_2012">
<p>Qiu, Fang, Caiyun Zhang, and Yuhong Zhou. 2012. “The Development of an Areal Interpolation ArcGIS Extension and a Comparative Study.” <em>GIScience &amp; Remote Sensing</em> 49 (5): 644–63. <a href="https://doi.org/10.2747/1548-1603.49.5.644">https://doi.org/10.2747/1548-1603.49.5.644</a>.</p>
</div>
<div id="ref-tobler_smooth_1979">
<p>Tobler, Waldo R. 1979. “Smooth Pycnophylactic Interpolation for Geographical Regions.” <em>Journal of the American Statistical Association</em> 74 (367): 519–30. <a href="https://doi.org/10.1080/01621459.1979.10481647">https://doi.org/10.1080/01621459.1979.10481647</a>.</p>
</div>
<div id="ref-tomlin_geographic_1990">
<p>Tomlin, C. Dana. 1990. <em>Geographic Information Systems and Cartographic Modeling</em>. Englewood Cliffs, N.J: Prentice Hall.</p>
</div>
<div id="ref-wegmann_remote_2016">
<p>Wegmann, Martin, Benjamin Leutner, and Stefan Dech, eds. 2016. <em>Remote Sensing and GIS for Ecologists: Using Open Source Software</em>. Data in the Wild. Exeter: Pelagic Publishing.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="17">
<li id="fn17"><p>
This can be verified with <code>identical(st_geometry(nz), st_geometry(nz_avheight))</code>.<a href="spatial-operations.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p>
Map algebra operations are also possible with headerless rasters; in this case the user has to make sure that in fact there exists a one-to-one locational correspondence.
An example showing how to import a headerless raster into R is provided in a post at <a href="https://stat.ethz.ch/pipermail/r-sig-geo/2013-May/018278.html" class="uri">https://stat.ethz.ch/pipermail/r-sig-geo/2013-May/018278.html</a>.<a href="spatial-operations.html#fnref18" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
<script>
/*
Sorts the references alphabetically.
Modified from code by Yvonne Aburrow.
*/
$(function(){
    var elems = $('#refs').children('div').remove();
    elems.sort(function (a, b) {
        return $(b).children('p').html().toUpperCase() > $(a).children('p').html().toUpperCase() ? -1 : 1;
    });
    $('#refs').append(elems);
})
</script>
            </section>

          </div>
        </div>
      </div>
<a href="attr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="geometric-operations.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Robinlovelace/geocompr/edit/master/04-spatial-operations.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
